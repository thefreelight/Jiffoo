# ğŸš€ Jiffoo Mall Core - GitLab CI/CD Pipeline
# å†…ç½‘ GitLab CI/CD é…ç½®ï¼Œä½¿ç”¨ Kubernetes Executor
# Last updated: 2025-12-07 - Improved CI/CD trigger strategy (industry best practice)

# ============================================
# ğŸ¯ CI/CD è§¦å‘è§„åˆ™ (è¡Œä¸šæœ€ä½³å®è·µ)
# ============================================
#
# ğŸ“‹ è§¦å‘ç­–ç•¥è¯´æ˜:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ æ“ä½œ                    â”‚ CI (æ„å»º+æµ‹è¯•) â”‚ CD (éƒ¨ç½²)           â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ æ™®é€š push åˆ° main       â”‚ âœ… è‡ªåŠ¨        â”‚ âŒ ä¸éƒ¨ç½²           â”‚
# â”‚ commit å« [deploy]      â”‚ âœ… è‡ªåŠ¨        â”‚ âœ… éƒ¨ç½²åˆ° dev       â”‚
# â”‚ æ‰‹åŠ¨è§¦å‘ Pipeline       â”‚ âœ… è‡ªåŠ¨        â”‚ âœ… éƒ¨ç½²åˆ° dev       â”‚
# â”‚ æ¨é€ tag (v*.*.*)       â”‚ âœ… è‡ªåŠ¨        â”‚ âœ… éƒ¨ç½²åˆ° prod      â”‚
# â”‚ MR (Merge Request)      â”‚ âœ… è‡ªåŠ¨        â”‚ âŒ ä¸éƒ¨ç½²           â”‚
# â”‚ commit å« [skip ci]     â”‚ âŒ è·³è¿‡        â”‚ âŒ è·³è¿‡             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ğŸ“ ä½¿ç”¨ç¤ºä¾‹:
#   # åªè¿è¡Œ CIï¼Œä¸éƒ¨ç½²
#   git commit -m "fix: some bug fix"
#   git push origin main
#
#   # è¿è¡Œ CI å¹¶éƒ¨ç½²åˆ° dev
#   git commit -m "feat: new feature [deploy]"
#   git push origin main
#
#   # éƒ¨ç½²åˆ° production
#   git tag v1.2.3
#   git push origin v1.2.3
#
#   # è·³è¿‡ CI (ä»…æ–‡æ¡£æ›´æ–°ç­‰)
#   git commit -m "docs: update readme [skip ci]"
#   git push origin main
#
# ============================================

workflow:
  rules:
    # è·³è¿‡ CI
    - if: $CI_COMMIT_MESSAGE =~ /\[skip ci\]|\[ci skip\]/
      when: never
    # Tag å‘å¸ƒ (è‡ªåŠ¨éƒ¨ç½²åˆ° prod)
    - if: $CI_COMMIT_TAG
    # main åˆ†æ”¯ (CI è‡ªåŠ¨è¿è¡Œï¼Œéƒ¨ç½²ç”± job çº§åˆ«æ§åˆ¶)
    - if: $CI_COMMIT_BRANCH == "main"
    # MR (åªè¿è¡Œ CIï¼Œä¸éƒ¨ç½²)
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# å…¨å±€å˜é‡
variables:
  # Git SSL é…ç½®ï¼ˆè‡ªç­¾åè¯ä¹¦ï¼‰
  GIT_SSL_NO_VERIFY: "true"

  # Harbor Registry (ä½¿ç”¨åŸŸåï¼Œæœ‰ TLS è¯ä¹¦)
  REGISTRY: "harbor.lafdru.local"
  REGISTRY_URL: "https://harbor.lafdru.local"
  HARBOR_DOMAIN: "harbor.lafdru.local"
  HARBOR_USERNAME: "admin"
  HARBOR_PASSWORD: "Harbor@2024"
  IMAGE_NAME: "jiffoo-mall-core"

  # Kaniko Remote Cache - ä½¿ç”¨ Harbor ä½œä¸ºç¼“å­˜ä»“åº“
  KANIKO_CACHE_REPO: "harbor.lafdru.local/jiffoo-mall-core/cache"

  # Turborepo Remote Cache
  TURBO_API: "http://192.168.0.113:3001"
  TURBO_TOKEN: "d7eb0b51c0899a3ef0c3a5cefc9989c45371d9974acd756c44bb967b0c0819af"
  TURBO_TEAM: "team_jiffoo-mall-core"

  # HTTP Proxy (for accessing Docker Hub)
  HTTP_PROXY: "http://192.168.0.106:7890"
  HTTPS_PROXY: "http://192.168.0.106:7890"
  NO_PROXY: "localhost,127.0.0.1,192.168.0.0/16,10.0.0.0/8,harbor.lafdru.local,git.lafdru.local,.lafdru.local"
  
  # API Service URLsï¼ˆåç«¯ API æœåŠ¡ç«¯å£ 30002ï¼‰
  API_SERVICE_URL: "http://jiffoo.chfastpay.com:30002"
  API_SERVICE_URL_PROD: "http://jiffoo.chfastpay.com:30002"
  API_SERVICE_URL_DEV: "http://jiffoo.chfastpay.com:30002"

  # Next.js Public Environment Variables
  # ç«¯å£æ˜ å°„ (ç²¾ç®€å 5 ä¸ªæ ¸å¿ƒæœåŠ¡):
  # Shop=30001, API=30002, Admin=30003, SuperAdmin=30004, DocsPublic=30005
  NEXT_PUBLIC_API_URL: ""
  NEXT_PUBLIC_SHOP_URL: "http://jiffoo.chfastpay.com:30001"
  NEXT_PUBLIC_ADMIN_URL: "http://jiffoo.chfastpay.com:30003"
  NEXT_PUBLIC_SUPER_ADMIN_URL: "http://jiffoo.chfastpay.com:30004"
  NEXT_PUBLIC_DOCS_URL: "http://jiffoo.chfastpay.com:30005"
  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: "pk_test_51R5gkPB6vJBDO7CtUURHcodqRpND2uVyDekor9ubS5hRZhMBSdATD0w4emWnGDCxuSSPqMBwlsQCdANyCHgzWdIx00ZaRNHHfr"
  
  # Node.js
  NODE_ENV: "production"
  
  # Docker
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  
  # Git
  GIT_DEPTH: 1
  GIT_STRATEGY: fetch

# å®šä¹‰ stages
stages:
  - prepare
  - build
  - test
  - security    # å®‰å…¨æ‰«æé˜¶æ®µ (æ–°å¢)
  - push
  - deploy
  - notify

# ğŸ¯ å‡†å¤‡é˜¶æ®µï¼šç¡®å®šç¯å¢ƒå’Œç‰ˆæœ¬
prepare:
  stage: prepare
  # tags:
  #   - kubernetes
  #   - docker
  #   - k8s
  image: alpine:latest
  timeout: 5 minutes
  script:
    - |
      echo "ğŸ¯ Determining environment and version..."

      # åˆ¤æ–­ç¯å¢ƒ (ä½¿ç”¨ sh å…¼å®¹çš„è¯­æ³•)
      if echo "$CI_COMMIT_TAG" | grep -q "^v"; then
        ENVIRONMENT="prod"
        NAMESPACE="jiffoo-mall-core-prod"
        VERSION="$CI_COMMIT_TAG"
      else
        ENVIRONMENT="dev"
        NAMESPACE="jiffoo-mall-core-dev"
        SHORT_SHA=$(echo "$CI_COMMIT_SHA" | cut -c1-7)
        VERSION="main-${SHORT_SHA}"
      fi

      echo "ğŸ“Š Environment: $ENVIRONMENT"
      echo "ğŸ“¦ Namespace: $NAMESPACE"
      echo "ğŸ·ï¸ Version: $VERSION"

      # ä¿å­˜åˆ°æ–‡ä»¶ä¾›åç»­ job ä½¿ç”¨
      echo "ENVIRONMENT=$ENVIRONMENT" >> build.env
      echo "NAMESPACE=$NAMESPACE" >> build.env
      echo "VERSION=$VERSION" >> build.env
  artifacts:
    reports:
      dotenv: build.env
    expire_in: 1 hour

# ğŸ—ï¸ æ„å»ºå’Œæ¨é€é•œåƒï¼ˆå¹¶è¡Œï¼‰
.build_template: &build_template
  stage: build
  # tags:
  #   - kubernetes
  #   - docker
  #   - k8s
  image: gcr.io/kaniko-project/executor:debug
  before_script:
    - |
      echo "ğŸ”§ Setting up Kaniko environment..."

      # é…ç½® HTTP ä»£ç†ï¼ˆç”¨äºè®¿é—® Docker Hubï¼‰
      export HTTP_PROXY="$HTTP_PROXY"
      export HTTPS_PROXY="$HTTPS_PROXY"
      export NO_PROXY="$NO_PROXY"
      echo "âœ… Configured HTTP proxy: $HTTP_PROXY"

      # æ·»åŠ  DNS è§£æåˆ° /etc/hosts
      echo "192.168.0.114 harbor.lafdru.local" >> /etc/hosts
      echo "192.168.0.117 npm.lafdru.local" >> /etc/hosts
      echo "âœ… Added Harbor DNS resolution"
      echo "âœ… Added NPM Registry DNS resolution"
      cat /etc/hosts | grep -E "harbor|npm"

      # åˆ›å»º Kaniko é…ç½®ç›®å½•
      mkdir -p /kaniko/.docker

      # åˆ›å»º Docker è®¤è¯é…ç½®ï¼ˆä½¿ç”¨ HTTPS registry + Docker Hub è®¤è¯ï¼‰
      AUTH=$(echo -n "$HARBOR_USERNAME:$HARBOR_PASSWORD" | base64)

      # å¦‚æœé…ç½®äº† Docker Hub è®¤è¯ï¼Œæ·»åŠ åˆ°é…ç½®ä¸­
      if [ -n "$DOCKERHUB_USERNAME" ] && [ -n "$DOCKERHUB_PASSWORD" ]; then
        DOCKERHUB_AUTH=$(echo -n "$DOCKERHUB_USERNAME:$DOCKERHUB_PASSWORD" | base64)
        cat > /kaniko/.docker/config.json <<EOF
      {
        "auths": {
          "$REGISTRY": {
            "auth": "$AUTH"
          },
          "https://index.docker.io/v1/": {
            "auth": "$DOCKERHUB_AUTH"
          }
        }
      }
      EOF
        echo "âœ… Docker Hub authentication configured"
      else
        cat > /kaniko/.docker/config.json <<EOF
      {
        "auths": {
          "$REGISTRY": {
            "auth": "$AUTH"
          }
        }
      }
      EOF
        echo "âš ï¸ No Docker Hub authentication configured (may hit rate limits)"
      fi

      echo "âœ… Kaniko configured for HTTPS registry: $REGISTRY"
  script:
    - |
      echo "ğŸ³ Building Docker image for $SERVICE with Kaniko..."

      IMAGE_TAG="$REGISTRY/$IMAGE_NAME/$SERVICE:$VERSION"
      LATEST_TAG="$REGISTRY/$IMAGE_NAME/$SERVICE:latest"

      # ä½¿ç”¨ Kaniko æ„å»ºå¹¶æ¨é€é•œåƒï¼ˆHTTPS registry + HTTP Proxyï¼‰
      # æ³¨å…¥æ„å»ºä¿¡æ¯ç”¨äº /health ç«¯ç‚¹
      BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

      /kaniko/executor \
        --context=$CI_PROJECT_DIR \
        --dockerfile=apps/$SERVICE/Dockerfile \
        --destination=$IMAGE_TAG \
        --destination=$LATEST_TAG \
        --skip-tls-verify \
        --cache=true \
        --cache-ttl=168h \
        --cache-repo=$KANIKO_CACHE_REPO/$SERVICE \
        --snapshot-mode=redo \
        --use-new-run \
        --build-arg TURBO_TOKEN="$TURBO_TOKEN" \
        --build-arg TURBO_TEAM="$TURBO_TEAM" \
        --build-arg TURBO_API="$TURBO_API" \
        --build-arg HTTP_PROXY="$HTTP_PROXY" \
        --build-arg HTTPS_PROXY="$HTTPS_PROXY" \
        --build-arg NO_PROXY="$NO_PROXY" \
        --build-arg BUILD_SHA="$CI_COMMIT_SHORT_SHA" \
        --build-arg BUILD_TIME="$BUILD_TIME" \
        --build-arg APP_VERSION="$VERSION" \
        --build-arg API_SERVICE_URL="$API_SERVICE_URL"

      echo "âœ… Build and push completed for $SERVICE"
  needs:
    - prepare
  dependencies:
    - prepare
  timeout: 45 minutes
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# å®šä¹‰æ‰€æœ‰æœåŠ¡çš„æ„å»ºä»»åŠ¡
# ç²¾ç®€åçš„æœåŠ¡åˆ—è¡¨ (5ä¸ªæ ¸å¿ƒæœåŠ¡):
# - api: åç«¯ API
# - shop: å‰ç«¯å•†åŸ
# - admin: å•†æˆ·ç®¡ç†åå° (åŸ tenant)
# - super-admin: è¶…çº§ç®¡ç†åå° (åŸ admin, Jiffoo Cloud è¿è¥)
# - docs-public: å…¬å¼€æ–‡æ¡£
# æ³¨: agent/white-label/distribution-plugin/docs-internal å·²æ”¶æ•›ä¸º super-admin æ¨¡å—

build:api:
  <<: *build_template
  variables:
    SERVICE: "api"

build:shop:
  <<: *build_template
  variables:
    SERVICE: "shop"

build:admin:
  <<: *build_template
  variables:
    SERVICE: "admin"

build:super-admin:
  <<: *build_template
  variables:
    SERVICE: "super-admin"

# docs-public æœåŠ¡å•ç‹¬æ„å»ºæ¨¡æ¿ - ç¦ç”¨ç¼“å­˜é¿å… Kaniko ç¼“å­˜é—®é¢˜
.build_docs_template: &build_docs_template
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - |
      # é…ç½® HTTP ä»£ç†
      export HTTP_PROXY="$HTTP_PROXY"
      export HTTPS_PROXY="$HTTPS_PROXY"
      export NO_PROXY="$NO_PROXY"
      echo "âœ… Configured HTTP proxy: $HTTP_PROXY"

      # æ·»åŠ  DNS è§£æåˆ° /etc/hosts
      echo "192.168.0.114 harbor.lafdru.local" >> /etc/hosts
      echo "192.168.0.117 npm.lafdru.local" >> /etc/hosts
      echo "âœ… Added Harbor DNS resolution"
      echo "âœ… Added NPM Registry DNS resolution"
      cat /etc/hosts | grep -E "harbor|npm"

      mkdir -p /kaniko/.docker
      REGISTRY="$HARBOR_DOMAIN"
      AUTH=$(echo -n "$HARBOR_USERNAME:$HARBOR_PASSWORD" | base64)

      cat > /kaniko/.docker/config.json << EOF
      {
        "auths": {
          "$REGISTRY": { "auth": "$AUTH" }
        },
        "proxies": {
          "default": {
            "httpProxy": "$HTTP_PROXY",
            "httpsProxy": "$HTTPS_PROXY",
            "noProxy": "$NO_PROXY"
          }
        }
      }
      EOF
      echo "âœ… Kaniko configured for HTTPS registry: $REGISTRY"
  script:
    - |
      echo "ğŸ³ Building Docker image for $SERVICE with Kaniko (cache disabled)..."

      IMAGE_TAG="$REGISTRY/$IMAGE_NAME/$SERVICE:$VERSION"
      LATEST_TAG="$REGISTRY/$IMAGE_NAME/$SERVICE:latest"

      BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

      /kaniko/executor \
        --context=$CI_PROJECT_DIR \
        --dockerfile=apps/$SERVICE/Dockerfile \
        --destination=$IMAGE_TAG \
        --destination=$LATEST_TAG \
        --skip-tls-verify \
        --cache=false \
        --snapshot-mode=redo \
        --use-new-run \
        --build-arg HTTP_PROXY="$HTTP_PROXY" \
        --build-arg HTTPS_PROXY="$HTTPS_PROXY" \
        --build-arg NO_PROXY="$NO_PROXY" \
        --build-arg BUILD_SHA="$CI_COMMIT_SHORT_SHA" \
        --build-arg BUILD_TIME="$BUILD_TIME" \
        --build-arg APP_VERSION="$VERSION"

      echo "âœ… Build and push completed for $SERVICE"
  needs:
    - prepare
  only:
    - main
  retry:
    max: 2
    when: script_failure
  allow_failure: true

# åªä¿ç•™ docs-publicï¼Œdocs-internal å·²æ”¶æ•›åˆ° super-admin
build:docs-public:
  <<: *build_docs_template
  variables:
    SERVICE: "docs-public"

# ğŸ§ª æµ‹è¯•é˜¶æ®µ
# æµ‹è¯•æ¨¡æ¿ - åŒ…å«ä»£ç†é…ç½®å’Œ DNS è§£æ
.test_template: &test_template
  before_script:
    # æ·»åŠ  DNS è§£æåˆ° /etc/hosts (è§£å†³ npm.lafdru.local æ— æ³•è§£æçš„é—®é¢˜)
    - echo "192.168.0.114 harbor.lafdru.local" >> /etc/hosts
    - echo "192.168.0.117 npm.lafdru.local" >> /etc/hosts
    - echo "âœ… Added DNS entries to /etc/hosts"
    - export NODE_ENV=development  # ç¡®ä¿å®‰è£… devDependencies (åŒ…å« turbo)
    - export HTTP_PROXY="http://192.168.0.106:7890"
    - export HTTPS_PROXY="http://192.168.0.106:7890"
    - export NO_PROXY="localhost,127.0.0.1,192.168.0.0/16,10.0.0.0/8,harbor.lafdru.local,git.lafdru.local,.lafdru.local,npm.lafdru.local"
    - echo "âœ… Configured HTTP proxy for npm registry"
    - corepack enable
    - corepack prepare pnpm@10.11.0 --activate
    - pnpm install --frozen-lockfile

test:lint:
  <<: *test_template
  stage: test
  image: node:20-alpine
  script:
    - echo "ğŸ” Running ESLint..."
    - pnpm lint || echo "âš ï¸ Lint warnings found, continuing..."
  allow_failure: true
  only:
    - main
    - merge_requests
    - tags

test:type-check:
  <<: *test_template
  stage: test
  image: node:20-alpine
  before_script:
    # æ·»åŠ  DNS è§£æåˆ° /etc/hosts (è§£å†³ npm.lafdru.local æ— æ³•è§£æçš„é—®é¢˜)
    - echo "192.168.0.114 harbor.lafdru.local" >> /etc/hosts
    - echo "192.168.0.117 npm.lafdru.local" >> /etc/hosts
    - echo "âœ… Added DNS entries to /etc/hosts"
    - export NODE_ENV=development
    - export HTTP_PROXY="http://192.168.0.106:7890"
    - export HTTPS_PROXY="http://192.168.0.106:7890"
    - export NO_PROXY="localhost,127.0.0.1,192.168.0.0/16,10.0.0.0/8,harbor.lafdru.local,git.lafdru.local,.lafdru.local,npm.lafdru.local"
    - echo "âœ… Configured HTTP proxy for npm registry"
    - corepack enable
    - corepack prepare pnpm@10.11.0 --activate
    - pnpm install --frozen-lockfile
    - pnpm --filter shared build  # å…ˆæ„å»º shared åŒ…ï¼Œå› ä¸º backend çš„ tsconfig paths æŒ‡å‘ shared/dist
    - pnpm --filter @jiffoo/ui build  # æ„å»º UI åŒ…ï¼Œå› ä¸º shop-themes ä¾èµ–å®ƒ
  script:
    - echo "ğŸ” Running TypeScript type check..."
    - pnpm type-check
  allow_failure: false
  only:
    - main
    - merge_requests
    - tags

test:unit:
  <<: *test_template
  stage: test
  image: node:20-alpine
  script:
    - echo "ğŸ§ª Running unit tests..."
    - pnpm test || echo "âš ï¸ No tests found or tests skipped"
  allow_failure: true
  only:
    - main
    - merge_requests
    - tags

# ============================================
# ğŸ”’ å®‰å…¨æ‰«æé˜¶æ®µ
# ============================================

# ä¾èµ–æ¼æ´æ‰«æ (npm audit)
security:dependency-audit:
  stage: security
  image: node:20-alpine
  before_script:
    - echo "192.168.0.117 npm.lafdru.local" >> /etc/hosts
    - export NODE_ENV=development
    - corepack enable
    - corepack prepare pnpm@10.11.0 --activate
  script:
    - echo "ğŸ” Running dependency vulnerability scan..."
    - pnpm audit --audit-level=high || echo "âš ï¸ Some vulnerabilities found"
    - echo "ğŸ“Š Generating audit report..."
    - pnpm audit --json > audit-report.json || true
  artifacts:
    when: always
    paths:
      - audit-report.json
    expire_in: 7 days
  allow_failure: true
  only:
    - main
    - merge_requests
    - tags

# é•œåƒå®‰å…¨æ‰«æ (Trivy)
security:trivy-scan:
  stage: security
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  variables:
    TRIVY_NO_PROGRESS: "true"
    TRIVY_CACHE_DIR: ".trivycache/"
  before_script:
    - echo "192.168.0.114 harbor.lafdru.local" >> /etc/hosts
  script:
    - echo "ğŸ” Running container image vulnerability scan..."
    # æ‰«æ API é•œåƒ
    - trivy image --exit-code 0 --severity HIGH,CRITICAL --skip-tls-verify "$REGISTRY/$IMAGE_NAME/api:$VERSION" || echo "âš ï¸ API image scan completed with findings"
    # æ‰«æ Shop é•œåƒ
    - trivy image --exit-code 0 --severity HIGH,CRITICAL --skip-tls-verify "$REGISTRY/$IMAGE_NAME/shop:$VERSION" || echo "âš ï¸ Shop image scan completed with findings"
    # ç”ŸæˆæŠ¥å‘Š
    - trivy image --format json --output trivy-report.json --skip-tls-verify "$REGISTRY/$IMAGE_NAME/api:$VERSION" || true
  artifacts:
    when: always
    paths:
      - trivy-report.json
    expire_in: 7 days
  allow_failure: true
  needs:
    - prepare
    - build:api
    - build:shop
  only:
    - main
    - tags

# ä»£ç å®‰å…¨æ‰«æ (Semgrep)
security:sast:
  stage: security
  image: returntocorp/semgrep:latest
  script:
    - echo "ğŸ” Running SAST scan with Semgrep..."
    - semgrep scan --config=auto --json --output=semgrep-report.json . || echo "âš ï¸ SAST scan completed"
    - semgrep scan --config=auto --sarif --output=semgrep-report.sarif . || true
  artifacts:
    when: always
    paths:
      - semgrep-report.json
      - semgrep-report.sarif
    expire_in: 7 days
  allow_failure: true
  only:
    - main
    - merge_requests

# ğŸš€ éƒ¨ç½²åˆ° Kubernetes
# éƒ¨ç½²è§¦å‘æ¡ä»¶ (è¡Œä¸šæœ€ä½³å®è·µ):
# 1. commit message åŒ…å« [deploy] - è‡ªåŠ¨éƒ¨ç½²åˆ° dev
# 2. æ‰‹åŠ¨è§¦å‘ Pipeline - è‡ªåŠ¨éƒ¨ç½²åˆ° dev
# 3. æ¨é€ tag (v*.*.*) - è‡ªåŠ¨éƒ¨ç½²åˆ° prod
# 4. æ™®é€š push åˆ° main - ä¸è§¦å‘éƒ¨ç½² (åªè¿è¡Œ CI)
deploy:
  stage: deploy
  # tags:
  #   - kubernetes
  #   - docker
  #   - k8s
  image: bitnami/kubectl:latest
  rules:
    # Tag å‘å¸ƒ - è‡ªåŠ¨éƒ¨ç½²åˆ° prod
    - if: $CI_COMMIT_TAG
      when: on_success
    # commit message åŒ…å« [deploy] - è‡ªåŠ¨éƒ¨ç½²åˆ° dev
    - if: $CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE =~ /\[deploy\]/
      when: on_success
    # æ‰‹åŠ¨è§¦å‘ Pipeline - è‡ªåŠ¨éƒ¨ç½²
    - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "web"
      when: on_success
    # æ™®é€š push åˆ° main - å¯æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true
  before_script:
    - |
      echo "ğŸ” Setting up Kubernetes credentials..."

      # æ–¹æ¡ˆ A: ä½¿ç”¨ KUBECONFIG æ–‡ä»¶å˜é‡ (GitLab File type variable)
      if [ -n "$KUBECONFIG" ] && [ -f "$KUBECONFIG" ]; then
        echo "ğŸ“ Using KUBECONFIG file variable..."
        mkdir -p ~/.kube
        cp "$KUBECONFIG" ~/.kube/config
        chmod 600 ~/.kube/config
        export KUBECONFIG=~/.kube/config
        echo "âœ… Kubeconfig configured from file variable"

      # æ–¹æ¡ˆ B: ä½¿ç”¨ KUBECONFIG_CONTENT (base64 ç¼–ç çš„ kubeconfig)
      elif [ -n "$KUBECONFIG_CONTENT" ]; then
        echo "ğŸ“ Using KUBECONFIG_CONTENT..."
        mkdir -p ~/.kube
        echo "$KUBECONFIG_CONTENT" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config
        export KUBECONFIG=~/.kube/config
        echo "âœ… Kubeconfig configured"

      # æ–¹æ¡ˆ C: ä½¿ç”¨ KUBE_TOKEN + KUBE_URL
      elif [ -n "$KUBE_TOKEN" ] && [ -n "$KUBE_URL" ]; then
        echo "ğŸ“ Using KUBE_TOKEN and KUBE_URL..."
        kubectl config set-cluster k8s --server="$KUBE_URL" --insecure-skip-tls-verify=true
        kubectl config set-credentials gitlab --token="$KUBE_TOKEN"
        kubectl config set-context default --cluster=k8s --user=gitlab
        kubectl config use-context default
        echo "âœ… Kubectl configured with token"

      # æ–¹æ¡ˆ D: å‡è®¾ Runner å·²ç»æœ‰ ServiceAccount (in-cluster config)
      else
        echo "âš ï¸ No explicit credentials found, assuming in-cluster ServiceAccount"
        echo "If this fails, please configure KUBECONFIG (File), KUBECONFIG_CONTENT, or (KUBE_TOKEN + KUBE_URL)"
      fi

      # éªŒè¯è¿æ¥
      echo "ğŸ” Testing Kubernetes connection..."
      echo "ğŸ“‹ Kubeconfig contexts:"
      kubectl config get-contexts 2>&1 || true
      echo "ğŸ“‹ Attempting cluster-info..."
      if kubectl cluster-info 2>&1; then
        echo "âœ… Successfully connected to Kubernetes cluster"
      else
        echo "âŒ Failed to connect to Kubernetes cluster"
        echo "ğŸ“‹ Debug: kubectl version --client"
        kubectl version --client 2>&1 || true
        echo "ğŸ“‹ Debug: cat kubeconfig (masked)"
        cat ~/.kube/config 2>&1 | head -20 | sed 's/certificate-authority-data:.*/certificate-authority-data: [MASKED]/' | sed 's/client-certificate-data:.*/client-certificate-data: [MASKED]/' | sed 's/client-key-data:.*/client-key-data: [MASKED]/' || true
        echo "Please check your credentials configuration"
        exit 1
      fi
  script:
    - |
      echo "ğŸš€ Deploying to Kubernetes..."
      echo "ğŸ“¦ Namespace: $NAMESPACE"
      echo "ğŸ·ï¸ Version: $VERSION"
      echo "ğŸ—ï¸ Registry: $REGISTRY"
      echo "ğŸ“¦ Image Name: $IMAGE_NAME"

      # æ£€æŸ¥ namespace æ˜¯å¦å­˜åœ¨
      if ! kubectl get namespace "$NAMESPACE" 2>/dev/null; then
        echo "âš ï¸ Namespace $NAMESPACE does not exist, creating it..."
        kubectl create namespace "$NAMESPACE" || echo "Failed to create namespace"
      fi

      # æ›´æ–°æ‰€æœ‰æœåŠ¡çš„é•œåƒ (ç²¾ç®€å 5 ä¸ªæ ¸å¿ƒæœåŠ¡)
      # é•œåƒå -> K8s Deployment å -> å®¹å™¨å æ˜ å°„
      # api -> backend -> backend
      # shop -> shop -> shop
      # admin -> admin -> admin (å•†æˆ·åå°, åŸ tenant)
      # super-admin -> super-admin -> super-admin (è¶…çº§ç®¡ç†åå°, åŸ admin)
      # docs-public -> docs-public -> docs-public
      # æ³¨: agent/white-label/distribution-plugin/docs-internal å·²æ”¶æ•›åˆ° super-admin

      FAILED_SERVICES=""

      # å®šä¹‰æ˜ å°„: IMAGE_NAME:DEPLOYMENT_NAME:CONTAINER_NAME
      SERVICES="api:backend:backend shop:shop:shop admin:admin:admin super-admin:super-admin:super-admin docs-public:docs-public:docs-public"

      for MAPPING in $SERVICES; do
        IMAGE_SERVICE=$(echo "$MAPPING" | cut -d: -f1)
        DEPLOY_NAME=$(echo "$MAPPING" | cut -d: -f2)
        CONTAINER_NAME=$(echo "$MAPPING" | cut -d: -f3)

        echo ""
        echo "ğŸ“¦ Updating $DEPLOY_NAME (image: $IMAGE_SERVICE, container: $CONTAINER_NAME)..."

        # æ£€æŸ¥ deployment æ˜¯å¦å­˜åœ¨
        if kubectl get deployment "jiffoo-mall-core-$DEPLOY_NAME" -n "$NAMESPACE" 2>/dev/null; then
          if kubectl set image deployment/jiffoo-mall-core-$DEPLOY_NAME \
            $CONTAINER_NAME=$REGISTRY/$IMAGE_NAME/$IMAGE_SERVICE:$VERSION \
            -n $NAMESPACE; then
            echo "âœ… Successfully updated $DEPLOY_NAME"
          else
            echo "âŒ Failed to update $DEPLOY_NAME"
            FAILED_SERVICES="$FAILED_SERVICES $DEPLOY_NAME"
          fi
        else
          echo "âš ï¸ Deployment jiffoo-mall-core-$DEPLOY_NAME not found in namespace $NAMESPACE"
          echo "ğŸ”§ Attempting to create deployment from template..."

          # å°è¯•ä» deploy/k8s/services ç›®å½•åˆ›å»º deployment
          DEPLOY_FILE="deploy/k8s/services/${IMAGE_SERVICE}-deployment.yaml"
          if [ -f "$DEPLOY_FILE" ]; then
            echo "ğŸ“„ Found deployment template: $DEPLOY_FILE"
            # æ›¿æ¢é•œåƒç‰ˆæœ¬å¹¶åªåº”ç”¨ Deployment éƒ¨åˆ†ï¼ˆä½¿ç”¨ yq æå–æˆ–é€šè¿‡ server-side apply å¼ºåˆ¶æ›´æ–°ï¼‰
            sed "s|image:.*|image: $REGISTRY/$IMAGE_NAME/$IMAGE_SERVICE:$VERSION|g" "$DEPLOY_FILE" | kubectl apply --server-side --force-conflicts -f -
            if [ $? -eq 0 ]; then
              echo "âœ… Successfully created/updated $DEPLOY_NAME resources"
            else
              echo "âŒ Failed to create $DEPLOY_NAME resources"
              FAILED_SERVICES="$FAILED_SERVICES $DEPLOY_NAME"
            fi
          else
            echo "âŒ No deployment template found at $DEPLOY_FILE"
            FAILED_SERVICES="$FAILED_SERVICES $DEPLOY_NAME"
          fi
        fi
      done

      echo ""
      if [ -n "$FAILED_SERVICES" ]; then
        echo "âš ï¸ Some services failed to update:$FAILED_SERVICES"
        echo "This might be expected if deployments don't exist yet"
        echo "âœ… Deployment process completed with warnings"
      else
        echo "âœ… All services updated successfully!"
      fi
  needs:
    - prepare
    - build:api
    - build:shop
    - build:admin
    - build:super-admin
    - job: build:docs-public
      optional: true  # docs æ„å»ºå¤±è´¥ä¸é˜»æ­¢éƒ¨ç½²
  dependencies:
    - prepare

# ğŸ”„ éƒ¨ç½²å›æ»šæœºåˆ¶
# æ‰‹åŠ¨è§¦å‘å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
rollback:
  stage: deploy
  image: bitnami/kubectl:latest
  rules:
    # åªå…è®¸æ‰‹åŠ¨è§¦å‘
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true
  before_script:
    - |
      echo "ğŸ” Setting up Kubernetes credentials..."
      if [ -n "$KUBECONFIG" ] && [ -f "$KUBECONFIG" ]; then
        mkdir -p ~/.kube
        cp "$KUBECONFIG" ~/.kube/config
        chmod 600 ~/.kube/config
        export KUBECONFIG=~/.kube/config
      elif [ -n "$KUBECONFIG_CONTENT" ]; then
        mkdir -p ~/.kube
        echo "$KUBECONFIG_CONTENT" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config
        export KUBECONFIG=~/.kube/config
      fi
  script:
    - |
      echo "ğŸ”„ Rolling back deployment..."
      echo "ğŸ“¦ Namespace: $NAMESPACE"

      SERVICES="backend shop admin super-admin"
      FAILED_ROLLBACKS=""

      for SERVICE in $SERVICES; do
        echo ""
        echo "ğŸ”„ Rolling back jiffoo-mall-core-$SERVICE..."
        if kubectl get deployment "jiffoo-mall-core-$SERVICE" -n "$NAMESPACE" 2>/dev/null; then
          if kubectl rollout undo deployment/jiffoo-mall-core-$SERVICE -n $NAMESPACE; then
            echo "âœ… Successfully rolled back $SERVICE"
            kubectl rollout status deployment/jiffoo-mall-core-$SERVICE -n $NAMESPACE --timeout=120s || true
          else
            echo "âŒ Failed to rollback $SERVICE"
            FAILED_ROLLBACKS="$FAILED_ROLLBACKS $SERVICE"
          fi
        else
          echo "âš ï¸ Deployment jiffoo-mall-core-$SERVICE not found"
        fi
      done

      if [ -n "$FAILED_ROLLBACKS" ]; then
        echo "âš ï¸ Some services failed to rollback:$FAILED_ROLLBACKS"
      else
        echo "âœ… All services rolled back successfully!"
      fi
  needs:
    - prepare
  dependencies:
    - prepare

# ğŸ—„ï¸ æ•°æ®åº“è¿ç§»å’Œç§å­æ•°æ®
# è§¦å‘æ¡ä»¶:
# - commit message åŒ…å« [migrate] - è¿è¡Œ migrate
# - commit message åŒ…å« [seed] - è¿è¡Œ migrate + seed
# - æ‰‹åŠ¨è§¦å‘
db-migrate:
  stage: deploy
  image: node:18-alpine
  rules:
    # commit message åŒ…å« [migrate] æˆ– [seed]
    - if: $CI_COMMIT_MESSAGE =~ /\[(migrate|seed)\]/
      when: on_success
    # æ‰‹åŠ¨è§¦å‘ (ä»»ä½•æ—¶å€™éƒ½å¯ä»¥æ‰‹åŠ¨æ‰§è¡Œ)
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true
  variables:
    # ä» GitLab CI/CD Variables è·å–æ•°æ®åº“è¿æ¥ä¿¡æ¯
    DATABASE_URL: $DATABASE_URL
    # å¼ºåˆ¶å®‰è£… devDependencies (Prisma CLI éœ€è¦)
    NODE_ENV: development
  before_script:
    - |
      echo "ğŸ—„ï¸ Database Migration Job"
      echo "ğŸ“¦ Installing dependencies..."
      apk add --no-cache openssl
      npm install -g pnpm@9.0.0
  script:
    - |
      echo "ğŸ” Checking database connection..."

      # æ£€æŸ¥ DATABASE_URL æ˜¯å¦è®¾ç½®
      if [ -z "$DATABASE_URL" ]; then
        echo "âŒ DATABASE_URL is not set!"
        echo "Please configure DATABASE_URL in GitLab CI/CD Variables"
        exit 1
      fi

      # å®‰è£…ä¾èµ– (ä½¿ç”¨ --ignore-scripts è·³è¿‡ husky prepare è„šæœ¬)
      echo "ğŸ“¦ Installing project dependencies..."
      pnpm install --frozen-lockfile --ignore-scripts

      # ç”Ÿæˆ Prisma Client (ä½¿ç”¨ exec ç›´æ¥è°ƒç”¨ prisma CLI)
      echo "ğŸ”§ Generating Prisma client..."
      cd apps/api && npx prisma generate && cd ../..

      # è¿è¡Œæ•°æ®åº“è¿ç§»
      echo "ğŸš€ Running database migrations..."
      cd apps/api

      # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥çš„ migrationï¼Œå¦‚æœæœ‰åˆ™å°è¯•è§£å†³
      echo "ğŸ” Checking migration status..."
      MIGRATE_STATUS=$(npx prisma migrate status 2>&1) || true
      echo "$MIGRATE_STATUS"

      if echo "$MIGRATE_STATUS" | grep -q "failed"; then
        echo "âš ï¸ Found failed migrations, attempting to resolve..."
        # ä» Prisma è¾“å‡ºä¸­æå–å¤±è´¥çš„ migration åç§°
        # æ ¼å¼é€šå¸¸æ˜¯: The `migration_name` migration started at ... failed
        # ä½¿ç”¨ sed æ›¿ä»£ grep -P (Alpine ä¸æ”¯æŒ -P)
        FAILED_MIGRATION=$(echo "$MIGRATE_STATUS" | sed -n 's/.*`\([^`]*\)` migration.*failed.*/\1/p' | head -1)

        if [ -z "$FAILED_MIGRATION" ]; then
          # å¤‡ç”¨æ–¹æ³•ï¼šç›´æ¥ä½¿ç”¨å·²çŸ¥çš„å¤±è´¥ migration åç§°
          echo "âš ï¸ Could not extract migration name, using known failed migration"
          FAILED_MIGRATION="20251209000000_fix_user_email_unique"
        fi

        echo "ğŸ”§ Marking migration as rolled back: $FAILED_MIGRATION"
        npx prisma migrate resolve --rolled-back "$FAILED_MIGRATION" || true

        echo "ğŸ”„ Retrying migration status check..."
        npx prisma migrate status || true
      fi

      echo "ğŸš€ Deploying migrations..."
      npx prisma migrate deploy
      cd ../..

      # æ£€æŸ¥æ˜¯å¦éœ€è¦è¿è¡Œ seed
      if echo "$CI_COMMIT_MESSAGE" | grep -q "\[seed\]"; then
        echo "ğŸŒ± Running database seed..."
        pnpm --filter api db:seed
        echo "âœ… Database seeded successfully!"
      fi

      echo "âœ… Database migration completed!"
  needs:
    - prepare
  dependencies:
    - prepare

# ============================================
# ğŸ”” é£ä¹¦é€šçŸ¥
# ============================================

# éƒ¨ç½²æˆåŠŸé€šçŸ¥
notify-success:
  stage: notify
  image: curlimages/curl:latest
  script:
    - |
      echo "ğŸ“¢ Sending success notification to Feishu..."

      # æ£€æŸ¥ FEISHU_WEBHOOK_URL æ˜¯å¦è®¾ç½®
      if [ -z "$FEISHU_WEBHOOK_URL" ]; then
        echo "âš ï¸ FEISHU_WEBHOOK_URL is not set, skipping notification"
        exit 0
      fi

      # æ„å»ºæ¶ˆæ¯å†…å®¹
      COMMIT_SHORT_SHA=$(echo $CI_COMMIT_SHA | cut -c1-8)
      BASE_URL="http://jiffoo.chfastpay.com"
      PIPELINE_URL="$CI_PROJECT_URL/-/pipelines/$CI_PIPELINE_ID"

      # å‘é€é£ä¹¦å¡ç‰‡æ¶ˆæ¯
      curl -X POST "$FEISHU_WEBHOOK_URL" \
        -H 'Content-Type: application/json' \
        -d "{
          \"msg_type\": \"interactive\",
          \"card\": {
            \"header\": {
              \"title\": {
                \"tag\": \"plain_text\",
                \"content\": \"ğŸš€ Jiffoo Mall éƒ¨ç½²é€šçŸ¥\"
              },
              \"template\": \"green\"
            },
            \"elements\": [
              {
                \"tag\": \"div\",
                \"text\": {
                  \"tag\": \"lark_md\",
                  \"content\": \"**çŠ¶æ€:** âœ… éƒ¨ç½²æˆåŠŸ\\n**ç¯å¢ƒ:** $DEPLOY_ENV\\n**ç‰ˆæœ¬:** $CI_COMMIT_REF_NAME-$COMMIT_SHORT_SHA\\n**åˆ†æ”¯:** $CI_COMMIT_REF_NAME\\n**æäº¤:** $CI_COMMIT_SHA\\n**è§¦å‘è€…:** $GITLAB_USER_NAME\"
                }
              },
              {
                \"tag\": \"hr\"
              },
              {
                \"tag\": \"div\",
                \"text\": {
                  \"tag\": \"lark_md\",
                  \"content\": \"**æœåŠ¡çŠ¶æ€:**\\nbackend: âœ… æˆåŠŸ\\nshop: âœ… æˆåŠŸ\\nadmin: âœ… æˆåŠŸ\\nsuper-admin: âœ… æˆåŠŸ\\ndocs-public: âœ… æˆåŠŸ\"
                }
              },
              {
                \"tag\": \"hr\"
              },
              {
                \"tag\": \"div\",
                \"text\": {
                  \"tag\": \"lark_md\",
                  \"content\": \"ğŸŒ **æœåŠ¡è®¿é—®åœ°å€** ($DEPLOY_ENVç¯å¢ƒ - NodePort):\"
                }
              },
              {
                \"tag\": \"action\",
                \"actions\": [
                  {
                    \"tag\": \"button\",
                    \"text\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"ğŸ›’ Shop\"
                    },
                    \"type\": \"default\",
                    \"url\": \"${BASE_URL}:30001\"
                  },
                  {
                    \"tag\": \"button\",
                    \"text\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"ğŸ”§ Backend API\"
                    },
                    \"type\": \"default\",
                    \"url\": \"${BASE_URL}:30002\"
                  },
                  {
                    \"tag\": \"button\",
                    \"text\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"ğŸ‘©â€ğŸ’¼ Admin\"
                    },
                    \"type\": \"default\",
                    \"url\": \"${BASE_URL}:30003\"
                  }
                ]
              },
              {
                \"tag\": \"action\",
                \"actions\": [
                  {
                    \"tag\": \"button\",
                    \"text\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"ğŸ‘‘ Super Admin\"
                    },
                    \"type\": \"default\",
                    \"url\": \"${BASE_URL}:30004\"
                  },
                  {
                    \"tag\": \"button\",
                    \"text\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"ğŸ“– Docs Public\"
                    },
                    \"type\": \"default\",
                    \"url\": \"${BASE_URL}:30005\"
                  }
                ]
              },
              {
                \"tag\": \"hr\"
              },
              {
                \"tag\": \"action\",
                \"actions\": [
                  {
                    \"tag\": \"button\",
                    \"text\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"ğŸ“‹ æŸ¥çœ‹éƒ¨ç½²è¯¦æƒ…\"
                    },
                    \"type\": \"primary\",
                    \"url\": \"$PIPELINE_URL\"
                  }
                ]
              }
            ]
          }
        }"

      echo "âœ… Notification sent"
  needs:
    - deploy
  rules:
    # Tag å‘å¸ƒ
    - if: $CI_COMMIT_TAG
      when: on_success
    # commit message åŒ…å« [deploy]
    - if: $CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE =~ /\[deploy\]/
      when: on_success
    # æ‰‹åŠ¨è§¦å‘ Pipeline
    - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "web"
      when: on_success
    # æ‰‹åŠ¨éƒ¨ç½²å
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
      allow_failure: true

# éƒ¨ç½²å¤±è´¥é€šçŸ¥
notify-failure:
  stage: notify
  image: curlimages/curl:latest
  script:
    - |
      echo "ğŸ“¢ Sending failure notification to Feishu..."

      # æ£€æŸ¥ FEISHU_WEBHOOK_URL æ˜¯å¦è®¾ç½®
      if [ -z "$FEISHU_WEBHOOK_URL" ]; then
        echo "âš ï¸ FEISHU_WEBHOOK_URL is not set, skipping notification"
        exit 0
      fi

      # æ„å»ºæ¶ˆæ¯å†…å®¹
      COMMIT_SHORT_SHA=$(echo $CI_COMMIT_SHA | cut -c1-8)
      PIPELINE_URL="$CI_PROJECT_URL/-/pipelines/$CI_PIPELINE_ID"

      # å‘é€é£ä¹¦å¡ç‰‡æ¶ˆæ¯
      curl -X POST "$FEISHU_WEBHOOK_URL" \
        -H 'Content-Type: application/json' \
        -d "{
          \"msg_type\": \"interactive\",
          \"card\": {
            \"header\": {
              \"title\": {
                \"tag\": \"plain_text\",
                \"content\": \"ğŸš€ Jiffoo Mall éƒ¨ç½²é€šçŸ¥\"
              },
              \"template\": \"red\"
            },
            \"elements\": [
              {
                \"tag\": \"div\",
                \"text\": {
                  \"tag\": \"lark_md\",
                  \"content\": \"**çŠ¶æ€:** âŒ éƒ¨ç½²å¤±è´¥\\n**ç¯å¢ƒ:** $DEPLOY_ENV\\n**ç‰ˆæœ¬:** $CI_COMMIT_REF_NAME-$COMMIT_SHORT_SHA\\n**åˆ†æ”¯:** $CI_COMMIT_REF_NAME\\n**æäº¤:** $CI_COMMIT_SHA\\n**è§¦å‘è€…:** $GITLAB_USER_NAME\"
                }
              },
              {
                \"tag\": \"hr\"
              },
              {
                \"tag\": \"div\",
                \"text\": {
                  \"tag\": \"lark_md\",
                  \"content\": \"âš ï¸ **éƒ¨ç½²è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·æŸ¥çœ‹ Pipeline æ—¥å¿—æ’æŸ¥é—®é¢˜ã€‚**\"
                }
              },
              {
                \"tag\": \"hr\"
              },
              {
                \"tag\": \"action\",
                \"actions\": [
                  {
                    \"tag\": \"button\",
                    \"text\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"ğŸ“‹ æŸ¥çœ‹éƒ¨ç½²è¯¦æƒ…\"
                    },
                    \"type\": \"danger\",
                    \"url\": \"$PIPELINE_URL\"
                  }
                ]
              }
            ]
          }
        }"

      echo "âœ… Notification sent"
  needs:
    - deploy
  rules:
    # Tag å‘å¸ƒ
    - if: $CI_COMMIT_TAG
      when: on_failure
    # commit message åŒ…å« [deploy]
    - if: $CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE =~ /\[deploy\]/
      when: on_failure
    # æ‰‹åŠ¨è§¦å‘ Pipeline
    - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "web"
      when: on_failure
    # æ‰‹åŠ¨éƒ¨ç½²å
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_failure
      allow_failure: true

# ============================================
# ğŸ§ª æµ‹è¯•ç¯å¢ƒ E2E æµ‹è¯•
# ============================================

# éƒ¨ç½²åè‡ªåŠ¨è¿è¡Œ E2E æµ‹è¯•
test:e2e-staging:
  stage: notify
  image: mcr.microsoft.com/playwright:v1.40.0-jammy
  variables:
    # æµ‹è¯•ç¯å¢ƒ URLs
    STAGING_SHOP_URL: "http://jiffoo.chfastpay.com:30001"
    STAGING_API_URL: "http://jiffoo.chfastpay.com:30002"
    STAGING_ADMIN_URL: "http://jiffoo.chfastpay.com:30003"
    STAGING_SUPER_ADMIN_URL: "http://jiffoo.chfastpay.com:30004"
  before_script:
    - echo "192.168.0.117 npm.lafdru.local" >> /etc/hosts
    - export HTTP_PROXY="http://192.168.0.106:7890"
    - export HTTPS_PROXY="http://192.168.0.106:7890"
    - export NO_PROXY="localhost,127.0.0.1,192.168.0.0/16,jiffoo.chfastpay.com"
    - corepack enable
    - corepack prepare pnpm@10.11.0 --activate
    - pnpm install --frozen-lockfile
    - npx playwright install chromium --with-deps
  script:
    - echo "ğŸ§ª Running E2E tests against staging environment..."
    - echo "ğŸ“¡ Shop URL $STAGING_SHOP_URL"
    - echo "ğŸ“¡ API URL $STAGING_API_URL"
    - echo "ğŸ” Checking staging services..."
    - curl -s -o /dev/null -w "%{http_code}" "$STAGING_SHOP_URL" || echo "Shop unreachable"
    - curl -s -o /dev/null -w "%{http_code}" "$STAGING_API_URL/health" || echo "API unreachable"
    - echo "ğŸ§ª Running E2E tests..."
    - pnpm test:e2e:staging --project=shop || echo "âš ï¸ Some E2E tests failed"
  artifacts:
    when: always
    paths:
      - playwright-report-staging/
      - test-results/
    reports:
      junit: test-results/staging-junit.xml
    expire_in: 7 days
  needs:
    - deploy
  rules:
    # Tag å‘å¸ƒåè‡ªåŠ¨è¿è¡Œ
    - if: $CI_COMMIT_TAG
      when: on_success
    # commit message åŒ…å« [deploy] åè‡ªåŠ¨è¿è¡Œ
    - if: $CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE =~ /\[deploy\]/
      when: on_success
    # commit message åŒ…å« [e2e] å¼ºåˆ¶è¿è¡Œ
    - if: $CI_COMMIT_MESSAGE =~ /\[e2e\]/
      when: on_success
    # æ‰‹åŠ¨è§¦å‘
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true
  allow_failure: true  # E2E æµ‹è¯•å¤±è´¥ä¸é˜»æ­¢ pipeline

# å®šæ—¶å…¨é‡ E2E æµ‹è¯• (æ¯æ—¥å‡Œæ™¨ 2 ç‚¹)
test:e2e-scheduled:
  stage: test
  image: mcr.microsoft.com/playwright:v1.40.0-jammy
  variables:
    STAGING_SHOP_URL: "http://jiffoo.chfastpay.com:30001"
    STAGING_API_URL: "http://jiffoo.chfastpay.com:30002"
    STAGING_ADMIN_URL: "http://jiffoo.chfastpay.com:30003"
    STAGING_SUPER_ADMIN_URL: "http://jiffoo.chfastpay.com:30004"
  before_script:
    - echo "192.168.0.117 npm.lafdru.local" >> /etc/hosts
    - export HTTP_PROXY="http://192.168.0.106:7890"
    - export HTTPS_PROXY="http://192.168.0.106:7890"
    - export NO_PROXY="localhost,127.0.0.1,192.168.0.0/16,jiffoo.chfastpay.com"
    - corepack enable
    - corepack prepare pnpm@10.11.0 --activate
    - pnpm install --frozen-lockfile
    - npx playwright install chromium --with-deps
  script:
    - echo "ğŸ§ª Running scheduled full E2E test suite..."
    - pnpm test:e2e:staging
  artifacts:
    when: always
    paths:
      - playwright-report-staging/
      - test-results/
    reports:
      junit: test-results/staging-junit.xml
    expire_in: 14 days
  rules:
    # åªåœ¨å®šæ—¶è§¦å‘æ—¶è¿è¡Œ
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: on_success
  allow_failure: true

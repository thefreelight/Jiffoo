# ğŸš€ Jiffoo Mall (Open Source) - GitLab CI/CD Pipeline
# å†…ç½‘ GitLab CI/CD é…ç½®ï¼Œä½¿ç”¨ Kubernetes Executor

# å…¨å±€å˜é‡
variables:
  # Git SSL é…ç½®ï¼ˆè‡ªç­¾åè¯ä¹¦ï¼‰
  GIT_SSL_NO_VERIFY: "true"

  # Harbor Registry
  REGISTRY: "harbor.lafdru.local"
  REGISTRY_URL: "https://harbor.lafdru.local"
  HARBOR_DOMAIN: "harbor.lafdru.local"
  HARBOR_USERNAME: "admin"
  HARBOR_PASSWORD: "Harbor@2024"
  IMAGE_NAME: "jiffoo-opensource"

  # HTTP Proxy (for accessing Docker Hub)
  HTTP_PROXY: "http://192.168.0.106:7890"
  HTTPS_PROXY: "http://192.168.0.106:7890"
  NO_PROXY: "localhost,127.0.0.1,192.168.0.0/16,10.0.0.0/8,harbor.lafdru.local,git.lafdru.local,.lafdru.local"
  
  # API Service URLs
  API_SERVICE_URL: "http://jiffoo.chfastpay.com:31002"
  
  # Next.js Public Environment Variables
  NEXT_PUBLIC_API_URL: "http://jiffoo.chfastpay.com:31002"
  NEXT_PUBLIC_SHOP_URL: "http://jiffoo.chfastpay.com:31001"
  NEXT_PUBLIC_ADMIN_URL: "http://jiffoo.chfastpay.com:31003"
  
  # Node.js
  NODE_ENV: "production"
  
  # Docker
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  
  # Git
  GIT_DEPTH: 1
  GIT_STRATEGY: fetch

# å®šä¹‰ stages
stages:
  - prepare
  - build
  - test
  - deploy
  - notify

# ğŸ¯ å‡†å¤‡é˜¶æ®µ
prepare:
  stage: prepare
  image: alpine:latest
  timeout: 5 minutes
  script:
    - |
      echo "ğŸ¯ Determining environment and version..."

      if echo "$CI_COMMIT_TAG" | grep -q "^v"; then
        ENVIRONMENT="prod"
        NAMESPACE="jiffoo-opensource"
        VERSION="$CI_COMMIT_TAG"
      else
        ENVIRONMENT="dev"
        NAMESPACE="jiffoo-opensource"
        SHORT_SHA=$(echo "$CI_COMMIT_SHA" | cut -c1-7)
        VERSION="main-${SHORT_SHA}"
      fi

      echo "ğŸ“Š Environment: $ENVIRONMENT"
      echo "ğŸ“¦ Namespace: $NAMESPACE"
      echo "ğŸ·ï¸ Version: $VERSION"

      echo "ENVIRONMENT=$ENVIRONMENT" >> build.env
      echo "NAMESPACE=$NAMESPACE" >> build.env
      echo "VERSION=$VERSION" >> build.env
  artifacts:
    reports:
      dotenv: build.env
    expire_in: 1 hour

# ğŸ—ï¸ æ„å»ºæ¨¡æ¿
.build_template: &build_template
  stage: build
  image: gcr.io/kaniko-project/executor:debug
  before_script:
    - |
      echo "ğŸ”§ Setting up Kaniko environment..."
      export HTTP_PROXY="$HTTP_PROXY"
      export HTTPS_PROXY="$HTTPS_PROXY"
      export NO_PROXY="$NO_PROXY"
      
      echo "192.168.0.114 harbor.lafdru.local" >> /etc/hosts
      mkdir -p /kaniko/.docker
      AUTH=$(echo -n "$HARBOR_USERNAME:$HARBOR_PASSWORD" | base64)
      
      cat > /kaniko/.docker/config.json <<EOF
      {
        "auths": {
          "$REGISTRY": {
            "auth": "$AUTH"
          }
        }
      }
      EOF
      echo "âœ… Kaniko configured for HTTPS registry: $REGISTRY"
  script:
    - |
      echo "ğŸ³ Building Docker image for $SERVICE with Kaniko..."

      IMAGE_TAG="$REGISTRY/$IMAGE_NAME/$SERVICE:$VERSION"
      LATEST_TAG="$REGISTRY/$IMAGE_NAME/$SERVICE:latest"
      BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

      /kaniko/executor \
        --context=$CI_PROJECT_DIR \
        --dockerfile=apps/$SERVICE/Dockerfile \
        --destination=$IMAGE_TAG \
        --destination=$LATEST_TAG \
        --skip-tls-verify \
        --cache=true \
        --cache-ttl=24h \
        --build-arg HTTP_PROXY="$HTTP_PROXY" \
        --build-arg HTTPS_PROXY="$HTTPS_PROXY" \
        --build-arg NO_PROXY="$NO_PROXY" \
        --build-arg BUILD_SHA="$CI_COMMIT_SHORT_SHA" \
        --build-arg BUILD_TIME="$BUILD_TIME" \
        --build-arg APP_VERSION="$VERSION"

      echo "âœ… Build and push completed for $SERVICE"
  needs:
    - prepare
  dependencies:
    - prepare
  timeout: 45 minutes
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# æ„å»ºä»»åŠ¡
build:api:
  <<: *build_template
  variables:
    SERVICE: "api"

build:shop:
  <<: *build_template
  variables:
    SERVICE: "shop"

build:admin:
  <<: *build_template
  variables:
    SERVICE: "admin"

# ğŸ§ª æµ‹è¯•é˜¶æ®µ
test:type-check:
  stage: test
  image: node:20-alpine
  before_script:
    - export NODE_ENV=development
    - corepack enable
    - corepack prepare pnpm@10.11.0 --activate
    - pnpm install --frozen-lockfile
    - pnpm --filter shared build
  script:
    - echo "ğŸ” Running TypeScript type check..."
    - pnpm type-check
  allow_failure: false
  only:
    - main
    - merge_requests
    - tags

# ğŸš€ éƒ¨ç½²åˆ° Kubernetes
deploy:
  stage: deploy
  image: bitnami/kubectl:latest
  before_script:
    - |
      echo "ğŸ” Setting up Kubernetes credentials..."
      if [ -n "$KUBECONFIG" ] && [ -f "$KUBECONFIG" ]; then
        mkdir -p ~/.kube
        cp "$KUBECONFIG" ~/.kube/config
        chmod 600 ~/.kube/config
        export KUBECONFIG=~/.kube/config
      fi
      kubectl cluster-info
  script:
    - |
      echo "ğŸš€ Deploying to Kubernetes..."
      echo "ğŸ“¦ Namespace: $NAMESPACE"
      echo "ğŸ·ï¸ Version: $VERSION"

      # æ£€æŸ¥ namespace
      if ! kubectl get namespace "$NAMESPACE" 2>/dev/null; then
        kubectl create namespace "$NAMESPACE"
      fi

      # æ›´æ–°é•œåƒ
      FAILED_SERVICES=""
      for SERVICE in api shop admin; do
        echo "ğŸ“¦ Updating $SERVICE..."
        if kubectl get deployment "jiffoo-opensource-$SERVICE" -n "$NAMESPACE" 2>/dev/null; then
          if kubectl set image deployment/jiffoo-opensource-$SERVICE \
            $SERVICE=$REGISTRY/$IMAGE_NAME/$SERVICE:$VERSION \
            -n $NAMESPACE; then
            echo "âœ… Successfully updated $SERVICE"
          else
            FAILED_SERVICES="$FAILED_SERVICES $SERVICE"
          fi
        else
          echo "âš ï¸ Deployment jiffoo-opensource-$SERVICE not found"
          FAILED_SERVICES="$FAILED_SERVICES $SERVICE"
        fi
      done

      if [ -n "$FAILED_SERVICES" ]; then
        echo "âš ï¸ Some services failed:$FAILED_SERVICES"
      else
        echo "âœ… All services updated!"
      fi
  needs:
    - prepare
    - build:api
    - build:shop
    - build:admin
  dependencies:
    - prepare
  only:
    - main
    - tags
  allow_failure: true

# ============================================
# ğŸ”” é£ä¹¦é€šçŸ¥
# ============================================

notify-success:
  stage: notify
  image: curlimages/curl:latest
  script:
    - |
      echo "ğŸ“¢ Sending success notification to Feishu..."

      if [ -z "$FEISHU_WEBHOOK_URL" ]; then
        echo "âš ï¸ FEISHU_WEBHOOK_URL is not set, skipping notification"
        exit 0
      fi

      COMMIT_SHORT_SHA=$(echo $CI_COMMIT_SHA | cut -c1-8)
      BASE_URL="http://jiffoo.chfastpay.com"
      PIPELINE_URL="$CI_PROJECT_URL/-/pipelines/$CI_PIPELINE_ID"

      curl -X POST "$FEISHU_WEBHOOK_URL" \
        -H 'Content-Type: application/json' \
        -d "{
          \"msg_type\": \"interactive\",
          \"card\": {
            \"header\": {
              \"title\": {
                \"tag\": \"plain_text\",
                \"content\": \"âœ… Jiffoo å¼€æºç‰ˆéƒ¨ç½²é€šçŸ¥\"
              },
              \"template\": \"green\"
            },
            \"elements\": [
              {
                \"tag\": \"div\",
                \"text\": {
                  \"tag\": \"lark_md\",
                  \"content\": \"**çŠ¶æ€:** âœ… éƒ¨ç½²æˆåŠŸ\\n**é¡¹ç›®:** Jiffoo Mall (Open Source)\\n**ç‰ˆæœ¬:** $CI_COMMIT_REF_NAME-$COMMIT_SHORT_SHA\\n**åˆ†æ”¯:** $CI_COMMIT_REF_NAME\\n**è§¦å‘è€…:** $GITLAB_USER_NAME\"
                }
              },
              {
                \"tag\": \"hr\"
              },
              {
                \"tag\": \"div\",
                \"text\": {
                  \"tag\": \"lark_md\",
                  \"content\": \"**æœåŠ¡çŠ¶æ€:**\\napi: âœ… æˆåŠŸ\\nshop: âœ… æˆåŠŸ\\nadmin: âœ… æˆåŠŸ\"
                }
              },
              {
                \"tag\": \"hr\"
              },
              {
                \"tag\": \"div\",
                \"text\": {
                  \"tag\": \"lark_md\",
                  \"content\": \"ğŸŒ **å¤–éƒ¨è®¿é—®åœ°å€** (NodePort):\"
                }
              },
              {
                \"tag\": \"action\",
                \"actions\": [
                  {
                    \"tag\": \"button\",
                    \"text\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"ğŸ›’ Shop\"
                    },
                    \"type\": \"default\",
                    \"url\": \"${BASE_URL}:31001\"
                  },
                  {
                    \"tag\": \"button\",
                    \"text\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"ğŸ”§ API\"
                    },
                    \"type\": \"default\",
                    \"url\": \"${BASE_URL}:31002\"
                  },
                  {
                    \"tag\": \"button\",
                    \"text\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"ğŸ‘©â€ğŸ’¼ Admin\"
                    },
                    \"type\": \"default\",
                    \"url\": \"${BASE_URL}:31003\"
                  }
                ]
              },
              {
                \"tag\": \"hr\"
              },
              {
                \"tag\": \"div\",
                \"text\": {
                  \"tag\": \"lark_md\",
                  \"content\": \"ğŸ  **å†…éƒ¨è®¿é—®åœ°å€** (VPN):\"
                }
              },
              {
                \"tag\": \"action\",
                \"actions\": [
                  {
                    \"tag\": \"button\",
                    \"text\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"ğŸ›’ Shop\"
                    },
                    \"type\": \"default\",
                    \"url\": \"http://shop.lafdru.local\"
                  },
                  {
                    \"tag\": \"button\",
                    \"text\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"ğŸ”§ API\"
                    },
                    \"type\": \"default\",
                    \"url\": \"http://api.lafdru.local\"
                  },
                  {
                    \"tag\": \"button\",
                    \"text\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"ğŸ‘©â€ğŸ’¼ Admin\"
                    },
                    \"type\": \"default\",
                    \"url\": \"http://admin.lafdru.local\"
                  }
                ]
              },
              {
                \"tag\": \"hr\"
              },
              {
                \"tag\": \"action\",
                \"actions\": [
                  {
                    \"tag\": \"button\",
                    \"text\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"ğŸ“‹ æŸ¥çœ‹éƒ¨ç½²è¯¦æƒ…\"
                    },
                    \"type\": \"primary\",
                    \"url\": \"$PIPELINE_URL\"
                  }
                ]
              }
            ]
          }
        }"

      echo "âœ… Notification sent"
  only:
    - main
    - tags
  when: on_success

notify-failure:
  stage: notify
  image: curlimages/curl:latest
  script:
    - |
      echo "ğŸ“¢ Sending failure notification to Feishu..."

      if [ -z "$FEISHU_WEBHOOK_URL" ]; then
        echo "âš ï¸ FEISHU_WEBHOOK_URL is not set, skipping notification"
        exit 0
      fi

      COMMIT_SHORT_SHA=$(echo $CI_COMMIT_SHA | cut -c1-8)
      PIPELINE_URL="$CI_PROJECT_URL/-/pipelines/$CI_PIPELINE_ID"

      curl -X POST "$FEISHU_WEBHOOK_URL" \
        -H 'Content-Type: application/json' \
        -d "{
          \"msg_type\": \"interactive\",
          \"card\": {
            \"header\": {
              \"title\": {
                \"tag\": \"plain_text\",
                \"content\": \"ğŸš€ Jiffoo å¼€æºç‰ˆéƒ¨ç½²é€šçŸ¥\"
              },
              \"template\": \"red\"
            },
            \"elements\": [
              {
                \"tag\": \"div\",
                \"text\": {
                  \"tag\": \"lark_md\",
                  \"content\": \"**çŠ¶æ€:** âŒ éƒ¨ç½²å¤±è´¥\\n**é¡¹ç›®:** Jiffoo Mall (Open Source)\\n**ç‰ˆæœ¬:** $CI_COMMIT_REF_NAME-$COMMIT_SHORT_SHA\\n**åˆ†æ”¯:** $CI_COMMIT_REF_NAME\\n**è§¦å‘è€…:** $GITLAB_USER_NAME\"
                }
              },
              {
                \"tag\": \"hr\"
              },
              {
                \"tag\": \"div\",
                \"text\": {
                  \"tag\": \"lark_md\",
                  \"content\": \"âš ï¸ **éƒ¨ç½²è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·æŸ¥çœ‹ Pipeline æ—¥å¿—æ’æŸ¥é—®é¢˜ã€‚**\"
                }
              },
              {
                \"tag\": \"hr\"
              },
              {
                \"tag\": \"action\",
                \"actions\": [
                  {
                    \"tag\": \"button\",
                    \"text\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"ğŸ“‹ æŸ¥çœ‹éƒ¨ç½²è¯¦æƒ…\"
                    },
                    \"type\": \"danger\",
                    \"url\": \"$PIPELINE_URL\"
                  }
                ]
              }
            ]
          }
        }"

      echo "âœ… Notification sent"
  only:
    - main
    - tags
  when: on_failure

# Infrastructure Alerting Rules for Jiffoo Mall
# Prometheus alerting rules for infrastructure monitoring

groups:
  - name: infrastructure
    interval: 30s
    rules:
      # Harbor disk usage alert
      - alert: HarborDiskUsageHigh
        expr: |
          (1 - (node_filesystem_avail_bytes{mountpoint="/data"} / node_filesystem_size_bytes{mountpoint="/data"})) * 100 > 80
        for: 5m
        labels:
          severity: warning
          component: harbor
        annotations:
          summary: "Harbor disk usage is above 80%"
          description: "Harbor storage disk usage is {{ $value | printf \"%.1f\" }}% on {{ $labels.instance }}"
          runbook_url: "https://docs.jiffoo.com/runbooks/harbor-disk-usage"

      - alert: HarborDiskUsageCritical
        expr: |
          (1 - (node_filesystem_avail_bytes{mountpoint="/data"} / node_filesystem_size_bytes{mountpoint="/data"})) * 100 > 90
        for: 5m
        labels:
          severity: critical
          component: harbor
        annotations:
          summary: "Harbor disk usage is critical (>90%)"
          description: "Harbor storage disk usage is {{ $value | printf \"%.1f\" }}% on {{ $labels.instance }}. Immediate action required!"

      # Redis memory usage alert
      - alert: RedisMemoryUsageHigh
        expr: |
          redis_memory_used_bytes / redis_memory_max_bytes * 100 > 80
        for: 5m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "Redis memory usage is above 80%"
          description: "Redis memory usage is {{ $value | printf \"%.1f\" }}% on {{ $labels.instance }}"
          runbook_url: "https://docs.jiffoo.com/runbooks/redis-memory"

      - alert: RedisMemoryUsageCritical
        expr: |
          redis_memory_used_bytes / redis_memory_max_bytes * 100 > 95
        for: 2m
        labels:
          severity: critical
          component: redis
        annotations:
          summary: "Redis memory usage is critical (>95%)"
          description: "Redis memory usage is {{ $value | printf \"%.1f\" }}% on {{ $labels.instance }}. OOM risk!"

      # Kubernetes pod restart alert
      - alert: PodRestartingTooOften
        expr: |
          increase(kube_pod_container_status_restarts_total{namespace="jiffoo-mall-core-dev"}[5m]) > 3
        for: 1m
        labels:
          severity: warning
          component: kubernetes
        annotations:
          summary: "Pod {{ $labels.pod }} is restarting frequently"
          description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has restarted {{ $value }} times in the last 5 minutes"

      - alert: PodCrashLooping
        expr: |
          increase(kube_pod_container_status_restarts_total{namespace="jiffoo-mall-core-dev"}[15m]) > 5
        for: 5m
        labels:
          severity: critical
          component: kubernetes
        annotations:
          summary: "Pod {{ $labels.pod }} is crash looping"
          description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has restarted {{ $value }} times in 15 minutes. Likely application issue."

      # Node resource alerts
      - alert: NodeCPUHigh
        expr: |
          100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 10m
        labels:
          severity: warning
          component: node
        annotations:
          summary: "Node CPU usage is high"
          description: "Node {{ $labels.instance }} CPU usage is {{ $value | printf \"%.1f\" }}%"

      - alert: NodeMemoryHigh
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          component: node
        annotations:
          summary: "Node memory usage is high"
          description: "Node {{ $labels.instance }} memory usage is {{ $value | printf \"%.1f\" }}%"

      # Database alerts
      - alert: PostgresConnectionsHigh
        expr: |
          sum(pg_stat_activity_count) / pg_settings_max_connections * 100 > 80
        for: 5m
        labels:
          severity: warning
          component: postgres
        annotations:
          summary: "PostgreSQL connection usage is high"
          description: "PostgreSQL connection usage is {{ $value | printf \"%.1f\" }}%"

      - alert: PostgresReplicationLag
        expr: |
          pg_replication_lag > 30
        for: 5m
        labels:
          severity: warning
          component: postgres
        annotations:
          summary: "PostgreSQL replication lag is high"
          description: "PostgreSQL replication lag is {{ $value }}s on {{ $labels.instance }}"


name: Test MacMini Runner

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, develop ]
    paths:
      - '.github/workflows/test-macmini-runner.yml'

jobs:
  test-macmini:
    runs-on: [self-hosted, macmini, jiffoo]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: System Information
        run: |
          echo "ðŸ–¥ï¸  System Information:"
          echo "======================"
          echo "Hostname: $(hostname)"
          echo "OS: $(uname -s)"
          echo "Architecture: $(uname -m)"
          echo "CPU Cores: $(sysctl -n hw.ncpu)"
          echo "Memory: $(sysctl -n hw.memsize | awk '{print $1/1024/1024/1024 " GB"}')"
          echo "Disk Space:"
          df -h /
          echo ""
          
      - name: Runner Environment
        run: |
          echo "ðŸƒâ€â™‚ï¸ Runner Environment:"
          echo "======================"
          echo "Runner Name: $RUNNER_NAME"
          echo "Runner OS: $RUNNER_OS"
          echo "Runner Arch: $RUNNER_ARCH"
          echo "Working Directory: $(pwd)"
          echo "User: $(whoami)"
          echo "PATH: $PATH"
          echo ""
          
      - name: Network Test
        run: |
          echo "ðŸŒ Network Connectivity:"
          echo "======================="
          echo "GitHub API Test:"
          curl -s https://api.github.com/repos/thefreelight/Jiffoo | jq '.name, .full_name, .private' || echo "jq not available"
          echo ""
          echo "Internet Connectivity:"
          ping -c 3 8.8.8.8 || echo "Ping failed"
          echo ""
          
      - name: Development Tools Check
        run: |
          echo "ðŸ› ï¸  Development Tools:"
          echo "====================="
          echo "Node.js: $(node --version 2>/dev/null || echo 'Not installed')"
          echo "npm: $(npm --version 2>/dev/null || echo 'Not installed')"
          echo "Python: $(python3 --version 2>/dev/null || echo 'Not installed')"
          echo "Git: $(git --version 2>/dev/null || echo 'Not installed')"
          echo "Docker: $(docker --version 2>/dev/null || echo 'Not installed')"
          echo "kubectl: $(kubectl version --client --short 2>/dev/null || echo 'Not installed')"
          echo ""
          
      - name: MacMini Specific Tests
        run: |
          echo "ðŸŽ MacMini Specific Information:"
          echo "==============================="
          echo "macOS Version:"
          sw_vers
          echo ""
          echo "Hardware Overview:"
          system_profiler SPHardwareDataType | grep -E "(Model Name|Model Identifier|Processor|Memory|Serial Number)"
          echo ""
          echo "Available Simulators:"
          xcrun simctl list devices available 2>/dev/null | head -10 || echo "Xcode not available"
          echo ""
          
      - name: Workspace Test
        run: |
          echo "ðŸ“ Workspace Test:"
          echo "=================="
          echo "Creating test files..."
          mkdir -p test-workspace
          echo "Hello from MacMini Runner!" > test-workspace/test.txt
          echo "Timestamp: $(date)" >> test-workspace/test.txt
          echo "Runner: $RUNNER_NAME" >> test-workspace/test.txt
          
          echo "Test file contents:"
          cat test-workspace/test.txt
          
          echo "Cleaning up..."
          rm -rf test-workspace
          echo "âœ… Workspace test completed"
          
      - name: Success Notification
        run: |
          echo "ðŸŽ‰ MacMini Runner Test Completed Successfully!"
          echo "=============================================="
          echo "âœ… System information retrieved"
          echo "âœ… Network connectivity verified"
          echo "âœ… Development tools checked"
          echo "âœ… MacMini specific tests passed"
          echo "âœ… Workspace operations successful"
          echo ""
          echo "ðŸš€ MacMini Runner is ready for Jiffoo project builds!"
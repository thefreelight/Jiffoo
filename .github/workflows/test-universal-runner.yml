name: Test Universal MacMini Runner

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, develop ]
    paths:
      - '.github/workflows/test-universal-runner.yml'

jobs:
  test-universal-runner:
    runs-on: [self-hosted, macmini, universal]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: System Information
        run: |
          echo "ðŸ–¥ï¸  Universal Runner System Information:"
          echo "======================================="
          echo "Hostname: $(hostname)"
          echo "OS: $(uname -s)"
          echo "Architecture: $(uname -m)"
          echo "CPU Cores: $(sysctl -n hw.ncpu)"
          echo "Memory: $(sysctl -n hw.memsize | awk '{print $1/1024/1024/1024 " GB"}')"
          echo "Disk Space:"
          df -h /
          echo ""
          
      - name: Runner Environment
        run: |
          echo "ðŸƒâ€â™‚ï¸ Universal Runner Environment:"
          echo "================================="
          echo "Runner Name: $RUNNER_NAME"
          echo "Runner OS: $RUNNER_OS"
          echo "Runner Arch: $RUNNER_ARCH"
          echo "Repository: ${{ github.repository }}"
          echo "Working Directory: $(pwd)"
          echo "User: $(whoami)"
          echo "PATH: $PATH"
          echo ""
          
      - name: Multi-Repository Test
        run: |
          echo "ðŸ“¦ Multi-Repository Support Test:"
          echo "================================="
          echo "Current Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Event: ${{ github.event_name }}"
          echo ""
          echo "ðŸŽ¯ This Universal Runner can serve:"
          echo "â€¢ thefreelight/Jiffoo (å½“å‰ä»“åº“)"
          echo "â€¢ thefreelight/myshop"
          echo "â€¢ thefreelight/navtoai_next"
          echo "â€¢ thefreelight/lafdrue"
          echo "â€¢ thefreelight/esim"
          echo "â€¢ ä»¥åŠæ‰€æœ‰å…¶ä»– thefreelight ä»“åº“"
          echo ""
          
      - name: Network Connectivity Test
        run: |
          echo "ðŸŒ Network Connectivity Test:"
          echo "============================="
          
          # Test access to different repositories
          repos=("Jiffoo" "myshop" "navtoai_next" "lafdrue" "esim")
          for repo in "${repos[@]}"; do
            if curl -s --connect-timeout 5 "https://api.github.com/repos/thefreelight/$repo" > /dev/null; then
              echo "âœ… Can access thefreelight/$repo"
            else
              echo "âŒ Cannot access thefreelight/$repo"
            fi
          done
          echo ""
          
      - name: Development Tools Check
        run: |
          echo "ðŸ› ï¸  Development Tools Available:"
          echo "==============================="
          echo "Node.js: $(node --version 2>/dev/null || echo 'Not installed')"
          echo "npm: $(npm --version 2>/dev/null || echo 'Not installed')"
          echo "Python: $(python3 --version 2>/dev/null || echo 'Not installed')"
          echo "Git: $(git --version 2>/dev/null || echo 'Not installed')"
          echo "Docker: $(docker --version 2>/dev/null || echo 'Not installed')"
          echo "kubectl: $(kubectl version --client --short 2>/dev/null || echo 'Not installed')"
          echo ""
          
      - name: Universal Runner Labels Test
        run: |
          echo "ðŸ·ï¸  Universal Runner Labels:"
          echo "============================"
          echo "Available labels for workflows:"
          echo "â€¢ [self-hosted, macmini, universal]"
          echo "â€¢ [self-hosted, macos, arm64]"
          echo "â€¢ [self-hosted, thefreelight]"
          echo "â€¢ [self-hosted, universal]"
          echo ""
          echo "Example usage in other repositories:"
          echo "runs-on: [self-hosted, universal]"
          echo ""
          
      - name: Workspace Test
        run: |
          echo "ðŸ“ Workspace Test:"
          echo "=================="
          echo "Creating test workspace for ${{ github.repository }}..."
          mkdir -p test-workspace
          echo "Hello from Universal MacMini Runner!" > test-workspace/test.txt
          echo "Repository: ${{ github.repository }}" >> test-workspace/test.txt
          echo "Timestamp: $(date)" >> test-workspace/test.txt
          echo "Runner: Universal MacMini Runner" >> test-workspace/test.txt
          
          echo "Test file contents:"
          cat test-workspace/test.txt
          
          echo "Cleaning up..."
          rm -rf test-workspace
          echo "âœ… Workspace test completed"
          
      - name: Success Notification
        run: |
          echo "ðŸŽ‰ Universal MacMini Runner Test Completed Successfully!"
          echo "======================================================"
          echo "âœ… System information retrieved"
          echo "âœ… Multi-repository support verified"
          echo "âœ… Network connectivity tested"
          echo "âœ… Development tools checked"
          echo "âœ… Runner labels documented"
          echo "âœ… Workspace operations successful"
          echo ""
          echo "ðŸš€ Universal MacMini Runner is ready to serve ALL thefreelight repositories!"
          echo "ðŸ“¦ Current test: ${{ github.repository }}"
          echo "ðŸŒŸ Ready for: Jiffoo, MyShop, NavToAI, Lafdrue, eSIM, and more!"
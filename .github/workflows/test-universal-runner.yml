name: Test Universal MacMini Runner

on:
  workflow_dispatch:  # 手动触发
  push:
    branches: [ main, develop ]
    paths:
      - '.github/workflows/test-universal-runner.yml'

jobs:
  test-universal-runner:
    runs-on: [self-hosted, macmini, universal]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: System Information
        run: |
          echo "🖥️  Universal Runner System Information:"
          echo "======================================="
          echo "Hostname: $(hostname)"
          echo "OS: $(uname -s)"
          echo "Architecture: $(uname -m)"
          echo "CPU Cores: $(sysctl -n hw.ncpu)"
          echo "Memory: $(sysctl -n hw.memsize | awk '{print $1/1024/1024/1024 " GB"}')"
          echo "Disk Space:"
          df -h /
          echo ""
          
      - name: Runner Environment
        run: |
          echo "🏃‍♂️ Universal Runner Environment:"
          echo "================================="
          echo "Runner Name: $RUNNER_NAME"
          echo "Runner OS: $RUNNER_OS"
          echo "Runner Arch: $RUNNER_ARCH"
          echo "Repository: ${{ github.repository }}"
          echo "Working Directory: $(pwd)"
          echo "User: $(whoami)"
          echo "PATH: $PATH"
          echo ""
          
      - name: Multi-Repository Test
        run: |
          echo "📦 Multi-Repository Support Test:"
          echo "================================="
          echo "Current Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Event: ${{ github.event_name }}"
          echo ""
          echo "🎯 This Universal Runner can serve:"
          echo "• thefreelight/Jiffoo (当前仓库)"
          echo "• thefreelight/myshop"
          echo "• thefreelight/navtoai_next"
          echo "• thefreelight/lafdrue"
          echo "• thefreelight/esim"
          echo "• 以及所有其他 thefreelight 仓库"
          echo ""
          
      - name: Network Connectivity Test
        run: |
          echo "🌐 Network Connectivity Test:"
          echo "============================="
          
          # Test access to different repositories
          repos=("Jiffoo" "myshop" "navtoai_next" "lafdrue" "esim")
          for repo in "${repos[@]}"; do
            if curl -s --connect-timeout 5 "https://api.github.com/repos/thefreelight/$repo" > /dev/null; then
              echo "✅ Can access thefreelight/$repo"
            else
              echo "❌ Cannot access thefreelight/$repo"
            fi
          done
          echo ""
          
      - name: Development Tools Check
        run: |
          echo "🛠️  Development Tools Available:"
          echo "==============================="
          echo "Node.js: $(node --version 2>/dev/null || echo 'Not installed')"
          echo "npm: $(npm --version 2>/dev/null || echo 'Not installed')"
          echo "Python: $(python3 --version 2>/dev/null || echo 'Not installed')"
          echo "Git: $(git --version 2>/dev/null || echo 'Not installed')"
          echo "Docker: $(docker --version 2>/dev/null || echo 'Not installed')"
          echo "kubectl: $(kubectl version --client --short 2>/dev/null || echo 'Not installed')"
          echo ""
          
      - name: Universal Runner Labels Test
        run: |
          echo "🏷️  Universal Runner Labels:"
          echo "============================"
          echo "Available labels for workflows:"
          echo "• [self-hosted, macmini, universal]"
          echo "• [self-hosted, macos, arm64]"
          echo "• [self-hosted, thefreelight]"
          echo "• [self-hosted, universal]"
          echo ""
          echo "Example usage in other repositories:"
          echo "runs-on: [self-hosted, universal]"
          echo ""
          
      - name: Workspace Test
        run: |
          echo "📁 Workspace Test:"
          echo "=================="
          echo "Creating test workspace for ${{ github.repository }}..."
          mkdir -p test-workspace
          echo "Hello from Universal MacMini Runner!" > test-workspace/test.txt
          echo "Repository: ${{ github.repository }}" >> test-workspace/test.txt
          echo "Timestamp: $(date)" >> test-workspace/test.txt
          echo "Runner: Universal MacMini Runner" >> test-workspace/test.txt
          
          echo "Test file contents:"
          cat test-workspace/test.txt
          
          echo "Cleaning up..."
          rm -rf test-workspace
          echo "✅ Workspace test completed"
          
      - name: Success Notification
        run: |
          echo "🎉 Universal MacMini Runner Test Completed Successfully!"
          echo "======================================================"
          echo "✅ System information retrieved"
          echo "✅ Multi-repository support verified"
          echo "✅ Network connectivity tested"
          echo "✅ Development tools checked"
          echo "✅ Runner labels documented"
          echo "✅ Workspace operations successful"
          echo ""
          echo "🚀 Universal MacMini Runner is ready to serve ALL thefreelight repositories!"
          echo "📦 Current test: ${{ github.repository }}"
          echo "🌟 Ready for: Jiffoo, MyShop, NavToAI, Lafdrue, eSIM, and more!"
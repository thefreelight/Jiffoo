name: ğŸ§¹ Daily Runner Cleanup

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œæ¸…ç† (UTCæ—¶é—´)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      cleanup_level:
        description: 'Cleanup level'
        required: true
        default: 'normal'
        type: choice
        options:
        - normal
        - deep
        - emergency

jobs:
  daily-cleanup:
    name: ğŸ§¹ Dell R730 Daily Cleanup
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: 30
    
    steps:
      - name: ğŸ§¹ Daily system cleanup
        run: |
          echo "ğŸ§¹ Starting daily cleanup..."
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”§ Cleanup level: ${{ github.event.inputs.cleanup_level || 'scheduled' }}"
          
          # ğŸ“Š æ˜¾ç¤ºæ¸…ç†å‰çš„ç³»ç»ŸçŠ¶æ€
          echo "ğŸ“Š System status before cleanup:"
          df -h / | head -2
          docker system df || true
          echo "ğŸ’¾ Memory usage: $(free -h | head -2)"
          echo "ğŸ—‚ï¸ Temp directory size: $(du -sh /tmp 2>/dev/null || echo 'N/A')"
          
          # ğŸ³ Dockeræ¸…ç† (æ ¹æ®æ¸…ç†çº§åˆ«)
          CLEANUP_LEVEL="${{ github.event.inputs.cleanup_level || 'normal' }}"
          
          if [ "$CLEANUP_LEVEL" = "emergency" ]; then
            echo "ğŸš¨ EMERGENCY CLEANUP - Removing ALL Docker data!"
            docker system prune -a -f --volumes || true
            docker builder prune -a -f || true
            
          elif [ "$CLEANUP_LEVEL" = "deep" ]; then
            echo "ğŸ”¥ DEEP CLEANUP - Removing old Docker data"
            docker container prune -f || true
            docker image prune -a -f --filter until=6h || true
            docker builder prune -a -f --filter until=168h || true  # ä¿ç•™ 7 å¤©çš„ BuildKit ç¼“å­˜
            docker volume prune -f || true
            docker network prune -f || true

          else
            echo "ğŸ§¹ NORMAL CLEANUP - Removing unused Docker data"
            docker container prune -f || true
            docker image prune -f --filter until=24h || true
            docker builder prune -f --filter until=168h || true  # ä¿ç•™ 7 å¤©çš„ BuildKit ç¼“å­˜
            docker volume prune -f || true
            docker network prune -f || true
          fi
          
          # ğŸ—‘ï¸ æ¸…ç†ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶
          echo "ğŸ—‘ï¸ Cleaning system temp files..."
          sudo rm -rf /tmp/* || true
          sudo rm -rf /var/tmp/* || true
          sudo rm -rf /var/log/*.log.* || true  # æ¸…ç†æ—§æ—¥å¿—æ–‡ä»¶
          
          # ğŸ§¹ æ¸…ç†ç”¨æˆ·ç¼“å­˜
          echo "ğŸ§¹ Cleaning user caches..."
          rm -rf ~/.cache || true
          rm -rf ~/.npm/_cacache || true
          rm -rf ~/.pnpm-store || true
          rm -rf ~/.yarn/cache || true
          
          # ğŸ—‚ï¸ æ¸…ç†GitHub Actionså·¥ä½œç›®å½•
          echo "ğŸ—‚ï¸ Cleaning GitHub Actions workspace..."
          find /home/runner/work -name "node_modules" -type d -exec rm -rf {} + 2>/dev/null || true
          find /home/runner/work -name ".next" -type d -exec rm -rf {} + 2>/dev/null || true
          find /home/runner/work -name "dist" -type d -exec rm -rf {} + 2>/dev/null || true
          find /home/runner/work -name "build" -type d -exec rm -rf {} + 2>/dev/null || true
          rm -rf /home/runner/work/_temp || true
          
          # ğŸ“Š æ˜¾ç¤ºæ¸…ç†åçš„ç³»ç»ŸçŠ¶æ€
          echo "ğŸ“Š System status after cleanup:"
          df -h / | head -2
          docker system df || true
          echo "ğŸ’¾ Memory usage: $(free -h | head -2)"
          echo "ğŸ—‚ï¸ Temp directory size: $(du -sh /tmp 2>/dev/null || echo 'N/A')"
          
          # ğŸ¯ ç£ç›˜ä½¿ç”¨åˆ†æå’Œè­¦å‘Š
          DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
          echo "ğŸ“Š Current disk usage: ${DISK_USAGE}%"
          
          if [ "$DISK_USAGE" -gt 90 ]; then
            echo "ğŸš¨ CRITICAL: Disk usage is ${DISK_USAGE}% - EMERGENCY CLEANUP NEEDED!"
            exit 1
          elif [ "$DISK_USAGE" -gt 80 ]; then
            echo "âš ï¸ WARNING: Disk usage is ${DISK_USAGE}% - Consider deep cleanup!"
          elif [ "$DISK_USAGE" -gt 70 ]; then
            echo "âš ï¸ NOTICE: Disk usage is ${DISK_USAGE}% - Monitoring recommended"
          else
            echo "âœ… Disk usage is ${DISK_USAGE}% - Healthy level"
          fi
          
          # ğŸ“ˆ ç”Ÿæˆæ¸…ç†æŠ¥å‘Š
          echo "ğŸ“ˆ Cleanup Report:"
          echo "  ğŸ• Completed at: $(date)"
          echo "  ğŸ’¿ Disk usage: ${DISK_USAGE}%"
          echo "  ğŸ§¹ Cleanup level: $CLEANUP_LEVEL"
          echo "  ğŸ¯ Status: $([ "$DISK_USAGE" -lt 80 ] && echo "âœ… Healthy" || echo "âš ï¸ Needs attention")"
          
          echo "âœ… Daily cleanup completed!"
          echo "ğŸ‰ Dell R730 runner is optimized and ready!"

      - name: ğŸ“Š System health check
        run: |
          echo "ğŸ“Š Post-cleanup system health check..."
          
          # æ£€æŸ¥å…³é”®æœåŠ¡
          echo "ğŸ” Checking Docker service..."
          docker version || echo "âŒ Docker service issue detected"
          
          echo "ğŸ” Checking disk space..."
          df -h / | head -2
          
          echo "ğŸ” Checking memory..."
          free -h | head -2
          
          echo "ğŸ” Checking system load..."
          uptime
          
          echo "âœ… System health check completed!"

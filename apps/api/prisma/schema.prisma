// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["core"]
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String
  password  String
  avatar    String?
  role      String   @default("USER")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // E-commerce relations
  orders Order[]
  carts  Cart[] // User cart relation

  @@index([email])
  @@index([role])
  @@schema("core")
  @@map("users")
}

model Product {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  // Price and stock moved to ProductVariant
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Product type system
  productType String  @default("physical") // 'physical' | 'digital' | custom types
  typeData    String? // JSON: type-specific data (dimensions, files, etc.)

  // Physical product fields
  weight           Float? // Weight (grams)
  length           Float? // Length (cm)
  width            Float? // Width (cm)
  height           Float? // Height (cm)
  requiresShipping Boolean @default(true)
  shippingClass    String? // 'standard' | 'express' | 'fragile'

  // Relations
  categoryId            String?
  category              Category?              @relation(fields: [categoryId], references: [id])
  orderItems            OrderItem[]
  cartItems             CartItem[] // Cart product relation
  inventoryReservations InventoryReservation[] // Inventory reservation relation
  translations          ProductTranslation[] // Multi-language translation relation
  variants              ProductVariant[] // Product variant relation

  @@index([categoryId])
  @@index([productType])
  @@schema("core")
  @@map("products")
}

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  parentId    String?
  level       Int      @default(1)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@index([parentId])
  @@schema("core")
  @@map("categories")
}

model ProductVariant {
  id         String   @id @default(cuid())
  productId  String
  name       String // Variant name (e.g. "1-day plan", "7-day plan")
  attributes String? // JSON attributes (e.g. {"days": 1})
  basePrice  Float // Variant base price
  baseStock  Int      @default(0) // Variant base stock
  skuCode    String? // SKU code (optional)
  sortOrder  Int      @default(0) // Sorting order
  isActive   Boolean  @default(true) // Whether enabled
  isDefault  Boolean  @default(false) // Whether is default variant
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  product               Product                @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems            OrderItem[] // Order item relation
  cartItems             CartItem[] // Cart item relation
  inventoryReservations InventoryReservation[] // Inventory reservation relation

  @@index([productId])
  @@index([skuCode])
  @@schema("core")
  @@map("product_variants")
}

model ProductTranslation {
  id          String   @id @default(cuid())
  productId   String
  locale      String // 'en' | 'zh-Hans'
  name        String // Translated product name
  description String? // Translated product description
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, locale]) // Each product can have only one translation per locale
  @@index([productId])
  @@index([locale])
  @@schema("core")
  @@map("product_translations")
}

model Order {
  id     String @id @default(cuid())
  userId String
  status String @default("PENDING")

  // Payment status fields
  paymentStatus        String    @default("UNPAID") // UNPAID, PAID, FAILED, REFUNDED
  expiresAt            DateTime? // Order expiration time (30 mins after creation)
  lastPaymentAttemptAt DateTime? // Last payment attempt time
  paymentAttempts      Int       @default(0) // Number of payment attempts
  lastPaymentMethod    String? // Last payment method used
  cancelReason         String? // Cancellation reason
  cancelledAt          DateTime? // Cancellation time

  totalAmount       Float
  customerEmail     String?
  shippingAddressId String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user                  User                   @relation(fields: [userId], references: [id])
  shippingAddress       OrderAddress?          @relation(fields: [shippingAddressId], references: [id])
  items                 OrderItem[]
  payments              Payment[]
  shipments             Shipment[]
  refunds               Refund[]
  inventoryReservations InventoryReservation[] // Connected inventory reservations

  @@index([status])
  @@index([paymentStatus]) // New index
  @@index([expiresAt]) // New index (for scheduled cleanup)
  @@index([userId])
  @@schema("core")
  @@map("orders")
}

// Order Address Snapshot
model OrderAddress {
  id           String   @id @default(cuid())
  firstName    String
  lastName     String
  phone        String
  email        String?
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  country      String
  postalCode   String
  createdAt    DateTime @default(now())

  orders Order[]

  @@schema("core")
  @@map("order_addresses")
}

model OrderItem {
  id        String @id @default(cuid())
  orderId   String
  productId String
  variantId String // Product variant ID (Mandatory)
  quantity  Int
  unitPrice Float

  // Fulfillment status
  fulfillmentStatus String  @default("pending") // 'pending', 'processing', 'shipped', 'delivered', 'failed'
  fulfillmentData   String? // JSON: shipping tracking, etc.

  // Relations
  order         Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product        @relation(fields: [productId], references: [id])
  variant       ProductVariant @relation(fields: [variantId], references: [id]) // Variant relation
  shipmentItems ShipmentItem[] // Shipment item relation

  @@index([orderId])
  @@index([variantId]) // Variant index
  @@index([fulfillmentStatus]) // Fulfillment status index
  @@schema("core")
  @@map("order_items")
}

model Shipment {
  id             String    @id @default(cuid())
  orderId        String
  carrier        String? // Logistic company
  trackingNumber String?
  status         String    @default("PENDING") // PENDING, SHIPPED, DELIVERED, RETURNED
  shippedAt      DateTime?
  deliveredAt    DateTime?
  metadata       String? // JSON
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  order Order          @relation(fields: [orderId], references: [id])
  items ShipmentItem[]

  @@index([orderId])
  @@index([trackingNumber])
  @@schema("core")
  @@map("shipments")
}

model ShipmentItem {
  id          String   @id @default(cuid())
  shipmentId  String
  orderItemId String
  quantity    Int
  createdAt   DateTime @default(now())

  shipment  Shipment  @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  orderItem OrderItem @relation(fields: [orderItemId], references: [id])

  @@index([shipmentId])
  @@index([orderItemId])
  @@schema("core")
  @@map("shipment_items")
}

// Inventory Reservation Table - temporary lock for stock
// Supports variant-level stock reservation
model InventoryReservation {
  id        String   @id @default(cuid())
  orderId   String
  productId String
  variantId String // Variant ID (Mandatory)
  quantity  Int
  expiresAt DateTime // Expiration time (syncs with order expiration)
  status    String   @default("ACTIVE") // ACTIVE, RELEASED, CONFIRMED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id])
  variant ProductVariant @relation(fields: [variantId], references: [id])

  @@unique([orderId, productId, variantId]) // Each variant in an order can have only one reservation
  @@index([expiresAt, status]) // For scheduled cleanup of expired reservations
  @@index([productId, status]) // For calculating available stock
  @@index([variantId, status]) // For calculating variant available stock
  @@schema("core")
  @@map("inventory_reservations")
}

// Cart System - Only supports logged-in users
model Cart {
  id        String   @id @default(cuid())
  userId    String   @unique
  status    String   @default("ACTIVE")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@index([userId])
  @@index([status])
  @@schema("core")
  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  quantity  Int
  price     Float // Price snapshot when added to cart
  variantId String // Product variant ID (Mandatory)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cart    Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id])
  variant ProductVariant @relation(fields: [variantId], references: [id]) // Variant relation

  // Uniqueness constraint: same product/variant in the same cart
  @@unique([cartId, productId, variantId])
  @@index([cartId])
  @@index([productId])
  @@index([variantId]) // Variant index
  @@schema("core")
  @@map("cart_items")
}

// Payment Record Table
model Payment {
  id              String    @id @default(cuid())
  orderId         String
  attemptNumber   Int       @default(1) // Attempt number
  expiresAt       DateTime? // Session expiration time
  failureReason   String? // Reason for failure
  paymentMethod   String // 'stripe', 'paypal', etc.
  paymentIntentId String? // Stripe Payment Intent ID
  sessionId       String? // Stripe Checkout Session ID
  sessionUrl      String? // Stripe Checkout Session URL - For session reuse
  amount          Float
  currency        String    @default("USD")
  status          String    @default("PENDING") // 'PENDING', 'SUCCEEDED', 'FAILED'
  metadata        String? // Metadata (JSON)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  order   Order    @relation(fields: [orderId], references: [id])
  refunds Refund[]

  @@index([paymentIntentId])
  @@index([sessionId])
  @@index([orderId, attemptNumber])
  @@schema("core")
  @@map("payments")
}

// Refund Record Table
model Refund {
  id               String   @id @default(cuid())
  paymentId        String
  orderId          String
  amount           Float
  currency         String   @default("USD")
  status           String   @default("PENDING") // PENDING, SUCCEEDED, FAILED, CANCELLED
  reason           String?
  provider         String? // e.g., 'stripe'
  providerRefundId String?  @unique // ID returned by payment provider after success
  idempotencyKey   String   @unique // Mandatory business identity for idempotency
  metadata         String? // JSON
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  payment Payment @relation(fields: [paymentId], references: [id])
  order   Order   @relation(fields: [orderId], references: [id])

  @@index([paymentId])
  @@index([orderId])
  @@schema("core")
  @@map("refunds")
}

model SystemSettings {
  id String @id @default("system")

  // Installation status
  isInstalled Boolean   @default(false)
  installedAt DateTime?
  installedBy String? // Installing User ID

  // System version
  version       String    @default("1.0.0")
  lastUpdatedAt DateTime?

  // Global config (JSON)
  siteName        String  @default("Jiffoo Mall")
  siteDescription String?
  logoUrl         String?
  faviconUrl      String?

  // Feature toggles
  maintenanceMode          Boolean @default(false)
  allowRegistration        Boolean @default(true)
  requireEmailVerification Boolean @default(true)

  // Other settings (including theme rollback state)
  // theme.active.shop.slug / theme.previous.shop.slug
  settings String? // External settings (JSON)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("core")
  @@map("system_settings")
}

model PluginInstall {
  id String @id @default(cuid())

  // Plugin identifier
  slug String @unique // Plugin unique identifier

  // Plugin metadata
  name        String // Plugin name
  version     String // Plugin version
  author      String? // Plugin author
  description String? // Plugin description
  category    String? // Plugin category (e.g., 'payment', 'shipping')

  // Installation info
  source      String @default("local-zip") // 'builtin' | 'local-zip' | 'official-market'
  installPath String? // Relative path to extensions/plugins/ (null for builtin)

  // Status
  isEnabled Boolean @default(false) // Whether currently enabled

  // Plugin config (JSON)
  config String? // Config override

  installedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([isEnabled])
  @@schema("core")
  @@map("plugin_installs")
}

model InstalledTheme {
  id String @id @default(cuid())

  // Theme identifier
  slug   String @unique // Theme unique identifier
  target String // 'shop' | 'admin'

  // Theme metadata
  name        String // Theme name
  version     String // Theme version
  author      String? // Theme author
  description String? // Theme description

  // Installation info
  source      String @default("local-zip") // 'local-zip' | 'official-market'
  installPath String // Relative path to extensions/themes/

  // Status
  isActive Boolean @default(false) // Whether currently active (Can match SystemSettings)

  // Theme config (JSON)
  config String? // Config override

  installedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([target])
  @@index([isActive])
  @@schema("core")
  @@map("installed_themes")
}

// Outbox Event Table for Reliable Event Publishing
model OutboxEvent {
  id          String   @id @default(uuid())
  type        String   // e.g. "order.created"
  aggregateId String   // e.g. order-123
  payload     Json     // Full event data
  
  // Metadata
  version     String   @default("v1")
  occurredAt  DateTime @default(now())
  
  // Publishing Status
  published   Boolean  @default(false)
  publishedAt DateTime?
  retryCount  Int      @default(0)
  lastError   String?
  
  // Metadata for tracing
  traceId     String?
  actorId     String?
  
  @@index([published, occurredAt]) // For polling worker
  @@index([aggregateId])           // For debugging/ordering checks
  @@schema("core")
  @@map("outbox_events")
}


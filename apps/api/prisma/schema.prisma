// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
//
// ============================================
// ğŸ†• å•å•†æˆ·æ ¸å¿ƒæ¶æ„ - å®Œå…¨æ—  tenantId
// ============================================
// å¼€æºç‰ˆæœ¬è®¾è®¡åŸåˆ™:
// 1. æ‰€æœ‰ä¸šåŠ¡è¡¨å®Œå…¨ä¸åŒ…å« tenantId å­—æ®µ
// 2. å¤šç§Ÿæˆ·åŠŸèƒ½é€šè¿‡å®‰è£… @jiffoo/plugin-multi-tenant æ’ä»¶å¯ç”¨
// 3. æ’ä»¶é€šè¿‡æ•°æ®åº“è¿ç§»æ·»åŠ  tenantId åˆ—

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// æ ¸å¿ƒä¸šåŠ¡è¡¨ - æ—  tenantId
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique // å•å•†æˆ·æ¨¡å¼ä¸‹ email å…¨å±€å”¯ä¸€
  username  String
  password  String
  avatar    String?
  role      String   @default("USER") // 'USER', 'ADMIN'
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ç”µå•†ç›¸å…³å…³ç³»
  orders Order[]
  carts  Cart[] // ç”¨æˆ·è´­ç‰©è½¦å…³ç³»

  // OAuth 2.0 å’Œç¤¾äº¤ç™»å½•ç›¸å…³å…³ç³»
  socialAccounts SocialAccount[]
  oauth2Tokens   OAuth2AccessToken[]

  // å®¡è®¡æ—¥å¿—å…³ç³»
  auditLogs AuditLog[] @relation("UserAuditLogs")

  // ğŸ†• æ•°å­—å•†å“ä¸‹è½½è®°å½•
  downloadRecords DownloadRecord[]

  // CMS å†…å®¹å…³ç³»
  cmsPosts CmsPost[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Float    // åŸºç¡€ä»·æ ¼ï¼ˆå‘åå…¼å®¹ï¼‰
  stock       Int      @default(0) // åŸºç¡€åº“å­˜ï¼ˆå‘åå…¼å®¹ï¼‰
  category    String?
  images      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // ğŸ†• å•†å“ç±»å‹ç³»ç»Ÿ
  productType String  @default("physical") // 'physical' | 'digital' | custom types
  typeData    String? // JSON: type-specific data (dimensions, files, etc.)

  // ğŸ†• å®ç‰©å•†å“å­—æ®µ
  weight         Float?   // é‡é‡ (å…‹)
  length         Float?   // é•¿åº¦ (å˜ç±³)
  width          Float?   // å®½åº¦ (å˜ç±³)
  height         Float?   // é«˜åº¦ (å˜ç±³)
  requiresShipping Boolean @default(true)
  shippingClass  String?  // 'standard' | 'express' | 'fragile'

  // Relations
  orderItems            OrderItem[]
  cartItems             CartItem[] // è´­ç‰©è½¦å•†å“å…³ç³»
  inventoryReservations InventoryReservation[] // ğŸ†• åº“å­˜é¢„ç•™å…³ç³»
  translations          ProductTranslation[] // ğŸ†• å¤šè¯­è¨€ç¿»è¯‘å…³ç³»
  variants              ProductVariant[] // ğŸ†• å•†å“å˜ä½“å…³ç³»
  digitalFiles          ProductFile[] // ğŸ†• æ•°å­—æ–‡ä»¶å…³ç³»

  @@index([category])
  @@index([productType])
  @@map("products")
}

// ğŸ†• å•†å“å˜ä½“è¡¨ (SKU)
// æ¯ä¸ªProductå¯ä»¥æœ‰å¤šä¸ªå˜ä½“ï¼Œå¦‚ä¸åŒå¤©æ•°çš„å¥—é¤
model ProductVariant {
  id          String   @id @default(cuid())
  productId   String
  name        String   // å˜ä½“åç§°ï¼ˆå¦‚"1å¤©å¥—é¤"ã€"7å¤©å¥—é¤"ï¼‰
  attributes  String?  // JSONæ ¼å¼çš„å±æ€§ï¼ˆå¦‚ {"days": 1}ï¼‰
  basePrice   Float    // å˜ä½“åŸºç¡€ä»·æ ¼
  baseStock   Int      @default(0) // å˜ä½“åŸºç¡€åº“å­˜
  skuCode     String?  // SKUç¼–ç ï¼ˆå¯é€‰ï¼‰
  sortOrder   Int      @default(0) // æ’åº
  isActive    Boolean  @default(true) // æ˜¯å¦å¯ç”¨
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems  OrderItem[] // è®¢å•é¡¹å…³ç³»
  cartItems   CartItem[] // è´­ç‰©è½¦é¡¹å…³ç³»
  inventoryReservations InventoryReservation[] // ğŸ†• åº“å­˜é¢„ç•™å…³ç³»

  @@index([productId])
  @@index([skuCode])
  @@map("product_variants")
}

// ğŸ†• å•†å“å¤šè¯­è¨€ç¿»è¯‘è¡¨
// å­˜å‚¨å•†å“çš„å¤šè¯­è¨€å­—æ®µï¼Œæ”¯æŒ en å’Œ zh-Hant
model ProductTranslation {
  id          String   @id @default(cuid())
  productId   String
  locale      String   // 'en' | 'zh-Hant'
  name        String   // ç¿»è¯‘åçš„å•†å“åç§°
  description String?  // ç¿»è¯‘åçš„å•†å“æè¿°
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, locale]) // æ¯ä¸ªå•†å“æ¯ç§è¯­è¨€åªèƒ½æœ‰ä¸€æ¡ç¿»è¯‘
  @@index([productId])
  @@index([locale])
  @@map("product_translations")
}

// ğŸ†• æ•°å­—å•†å“æ–‡ä»¶è¡¨
model ProductFile {
  id          String   @id @default(cuid())
  productId   String
  name        String   // æ–‡ä»¶å
  size        Int      // æ–‡ä»¶å¤§å° (bytes)
  mimeType    String   // MIME ç±»å‹
  storageKey  String   // å­˜å‚¨é”®ï¼ˆä¸æš´éœ²çœŸå® URLï¼‰
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  product         Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  downloadRecords DownloadRecord[]

  @@index([productId])
  @@map("product_files")
}

// ğŸ†• ä¸‹è½½è®°å½•è¡¨
model DownloadRecord {
  id           String   @id @default(cuid())
  fileId       String
  orderId      String
  orderItemId  String
  userId       String
  ipAddress    String?
  userAgent    String?
  downloadedAt DateTime @default(now())

  // Relations
  file      ProductFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  order     Order       @relation(fields: [orderId], references: [id])
  orderItem OrderItem   @relation(fields: [orderItemId], references: [id])
  user      User        @relation(fields: [userId], references: [id])

  @@index([fileId])
  @@index([orderId])
  @@index([userId])
  @@map("download_records")
}

// ğŸ†• æ ¸å¿ƒæ¨¡å—é…ç½®è¡¨
model CoreModule {
  id          String   @id // 'physical-products' | 'digital-products'
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("core_modules")
}

model Order {
  id     String @id @default(cuid())
  userId String
  status String @default("PENDING")

  // ğŸ†• æ”¯ä»˜çŠ¶æ€å­—æ®µ
  paymentStatus        String    @default("UNPAID") // UNPAID, PAID, FAILED, REFUNDED
  expiresAt            DateTime? // è®¢å•è¿‡æœŸæ—¶é—´ï¼ˆåˆ›å»ºå30åˆ†é’Ÿï¼‰
  lastPaymentAttemptAt DateTime? // æœ€åä¸€æ¬¡æ”¯ä»˜å°è¯•æ—¶é—´
  paymentAttempts      Int       @default(0) // æ”¯ä»˜å°è¯•æ¬¡æ•°
  lastPaymentMethod    String? // æœ€åä¸€æ¬¡ä½¿ç”¨çš„æ”¯ä»˜æ–¹å¼ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰£APIæ¬¡æ•°ï¼‰
  cancelReason         String? // å–æ¶ˆåŸå› 
  cancelledAt          DateTime? // å–æ¶ˆæ—¶é—´

  totalAmount     Float
  customerEmail   String?
  shippingAddress String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user                  User                   @relation(fields: [userId], references: [id])
  items                 OrderItem[]
  payments              Payment[]
  inventoryReservations InventoryReservation[] // ğŸ†• å…³è”åº“å­˜é¢„ç•™
  downloadRecords       DownloadRecord[] // ğŸ†• ä¸‹è½½è®°å½•å…³ç³»

  @@index([status])
  @@index([paymentStatus]) // ğŸ†• æ–°å¢ç´¢å¼•
  @@index([expiresAt]) // ğŸ†• æ–°å¢ç´¢å¼•ï¼ˆç”¨äºå®šæ—¶ä»»åŠ¡æŸ¥è¯¢ï¼‰
  @@index([userId])
  @@map("orders")
}

model OrderItem {
  id        String @id @default(cuid())
  orderId   String
  productId String
  variantId String? // ğŸ†• å•†å“å˜ä½“IDï¼ˆæ–°å¢å­—æ®µï¼‰
  quantity  Int
  unitPrice Float

  // ğŸ†• å±¥çº¦çŠ¶æ€
  fulfillmentStatus String  @default("pending") // 'pending', 'processing', 'shipped', 'delivered', 'ready_for_download', 'downloaded', 'failed'
  fulfillmentData   String? // JSON: shipping tracking, download info, etc.

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id]) // ğŸ†• å˜ä½“å…³ç³»
  downloadRecords DownloadRecord[] // ğŸ†• ä¸‹è½½è®°å½•å…³ç³»

  @@index([orderId])
  @@index([variantId]) // ğŸ†• å˜ä½“ç´¢å¼•
  @@index([fulfillmentStatus]) // ğŸ†• å±¥çº¦çŠ¶æ€ç´¢å¼•
  @@map("order_items")
}

// ğŸ†• åº“å­˜é¢„ç•™è¡¨ - ç”¨äºä¸´æ—¶é”å®šåº“å­˜
// ğŸ†• æ”¯æŒå˜ä½“çº§åº“å­˜é¢„ç•™
model InventoryReservation {
  id        String   @id @default(cuid())
  orderId   String
  productId String
  variantId String?  // ğŸ†• å˜ä½“IDï¼ˆå¯é€‰ï¼Œå‘åå…¼å®¹ï¼‰
  quantity  Int
  expiresAt DateTime // é¢„ç•™è¿‡æœŸæ—¶é—´ï¼ˆä¸è®¢å•è¿‡æœŸæ—¶é—´ä¸€è‡´ï¼‰
  status    String   @default("ACTIVE") // ACTIVE, RELEASED, CONFIRMED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([orderId, productId, variantId]) // ğŸ†• æ¯ä¸ªè®¢å•çš„æ¯ä¸ªå•†å“å˜ä½“åªèƒ½æœ‰ä¸€æ¡é¢„ç•™è®°å½•
  @@index([expiresAt, status]) // ç”¨äºå®šæ—¶ä»»åŠ¡æŸ¥è¯¢è¿‡æœŸé¢„ç•™
  @@index([productId, status]) // ç”¨äºè®¡ç®—å¯ç”¨åº“å­˜
  @@index([variantId, status]) // ğŸ†• ç”¨äºè®¡ç®—å˜ä½“å¯ç”¨åº“å­˜
  @@map("inventory_reservations")
}

// è´­ç‰©è½¦ç³»ç»Ÿ - ä»…æ”¯æŒç™»å½•ç”¨æˆ·
model Cart {
  id        String   @id @default(cuid())
  userId    String   @unique // å•å•†æˆ·æ¨¡å¼ä¸‹æ¯ç”¨æˆ·åªæœ‰ä¸€ä¸ªè´­ç‰©è½¦
  status    String   @default("ACTIVE") // 'ACTIVE', 'CONVERTED'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items  CartItem[]

  @@index([userId])
  @@index([status])
  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  quantity  Int
  price     Float // åŠ å…¥è´­ç‰©è½¦æ—¶çš„ä»·æ ¼å¿«ç…§
  variantId String? // å•†å“å˜ä½“IDï¼ˆå¯é€‰ï¼‰
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id]) // ğŸ†• å˜ä½“å…³ç³»

  // é˜²é‡å¤çº¦æŸï¼šåŒä¸€è´­ç‰©è½¦ä¸­åŒä¸€å•†å“ï¼ˆå«å˜ä½“ï¼‰åªèƒ½æœ‰ä¸€æ¡è®°å½•
  @@unique([cartId, productId, variantId])
  @@index([cartId])
  @@index([productId])
  @@index([variantId]) // ğŸ†• å˜ä½“ç´¢å¼•
  @@map("cart_items")
}

// ============================================
// ç³»ç»Ÿç®¡ç†è¡¨ - æ—  tenantId
// ============================================

// æ“ä½œæ—¥å¿—
model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String // 'CREATE', 'UPDATE', 'DELETE', 'LOGIN', 'LOGOUT'
  module     String // 'users', 'products', 'orders', 'plugins'
  resourceId String? // è¢«æ“ä½œèµ„æºçš„ID
  oldValues  String? // JSONæ ¼å¼çš„æ—§å€¼
  newValues  String? // JSONæ ¼å¼çš„æ–°å€¼
  ipAddress  String?
  userAgent  String?
  metadata   String? // JSONæ ¼å¼çš„é¢å¤–å…ƒæ•°æ®
  createdAt  DateTime @default(now())

  // Relations
  user   User?   @relation("UserAuditLogs", fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([module])
  @@index([createdAt])
  @@map("audit_logs")
}

// Removed multilingual support tables

// OAuth 2.0 å’Œç¤¾äº¤ç™»å½•ç›¸å…³è¡¨

// ç¤¾äº¤è´¦æˆ·è¡¨
model SocialAccount {
  id           String    @id @default(cuid())
  userId       String
  provider     String // 'wechat', 'google', 'github', 'alipay'
  providerId   String // ç¬¬ä¸‰æ–¹å¹³å°çš„ç”¨æˆ·ID
  accessToken  String? // è®¿é—®ä»¤ç‰Œ
  refreshToken String? // åˆ·æ–°ä»¤ç‰Œ
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@index([provider])
  @@map("social_accounts")
}

// OAuth 2.0 æˆæƒç è¡¨
model OAuth2AuthorizationCode {
  id          String   @id @default(cuid())
  code        String   @unique
  state       String
  userId      String
  clientId    String
  redirectUri String
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@index([code])
  @@index([expiresAt])
  @@map("oauth2_authorization_codes")
}

// OAuth 2.0 è®¿é—®ä»¤ç‰Œè¡¨
model OAuth2AccessToken {
  id               String    @id @default(cuid())
  accessToken      String    @unique
  refreshToken     String?   @unique
  userId           String
  clientId         String
  scope            String?
  expiresAt        DateTime
  refreshExpiresAt DateTime?
  revoked          Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([accessToken])
  @@index([refreshToken])
  @@index([userId])
  @@index([expiresAt])
  @@index([revoked])
  @@map("oauth2_access_tokens")
}

// ============================================
// æ’ä»¶ç³»ç»Ÿç›¸å…³è¡¨
// ============================================

// æ’ä»¶è¡¨ - ç³»ç»Ÿçº§ï¼ˆå•å•†æˆ·æ¨¡å¼æ— éœ€æŒ‰ç§Ÿæˆ·éš”ç¦»ï¼‰
model Plugin {
  id              String  @id @default(cuid())
  slug            String  @unique // 'stripe-payment'
  name            String // 'Stripeæ”¯ä»˜'
  description     String?
  longDescription String? // è¯¦ç»†æè¿°
  category        String? // 'payment', 'marketing', 'analytics'
  tags            String? // JSONæ•°ç»„æ ¼å¼çš„æ ‡ç­¾
  iconUrl         String? // æ’ä»¶å›¾æ ‡URL
  screenshots     String? // JSONæ•°ç»„æ ¼å¼çš„æˆªå›¾URLs
  version         String  @default("1.0.0")
  status          String  @default("ACTIVE") // 'ACTIVE', 'INACTIVE'

  // ğŸ†• æ’ä»¶å…ƒæ•°æ®
  developer    String? @default("Jiffoo") // å¼€å‘è€…åç§°
  rating       Float?  @default(0) // è¯„åˆ† (0-5)
  installCount Int     @default(0) // å®‰è£…æ¬¡æ•°

  // ğŸ†• å¤–éƒ¨æ’ä»¶æ”¯æŒ
  runtimeType        String? @default("internal-fastify") // 'internal-fastify' | 'external-http'
  externalBaseUrl    String? // å¤–éƒ¨æ’ä»¶çš„åŸºç¡€URL
  oauthConfig        String? // JSONæ ¼å¼çš„OAuthé…ç½®ï¼š{installUrl, tokenUrl, redirectUri, scopes}
  integrationSecrets String? // JSONæ ¼å¼çš„é›†æˆå¯†é’¥ï¼š{sharedSecret}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  installations     PluginInstallation[]
  subscriptionPlans SubscriptionPlan[] // ğŸ†• è®¢é˜…è®¡åˆ’å…³ç³»
  payments          Payment[] // ğŸ†• æ”¯ä»˜è®°å½•å…³ç³»
  licenses          PluginLicense[] // ğŸ†• è®¸å¯è¯å…³ç³»

  @@map("plugins")
}

// æ’ä»¶è®¸å¯è¯è¡¨ - ç®¡ç†å•†ä¸šæ’ä»¶çš„è®¸å¯è¯
model PluginLicense {
  id             String    @id @default(cuid())
  pluginId       String // å…³è”çš„æ’ä»¶ slug
  status         String    @default("PENDING") // 'ACTIVE', 'EXPIRED', 'REVOKED', 'GRACE', 'PENDING'
  purchaseDate   DateTime  @default(now()) // è´­ä¹°æ—¥æœŸ
  activatedAt    DateTime? // æ¿€æ´»æ—¶é—´
  deactivatedAt  DateTime? // åœç”¨æ—¶é—´
  amount         Float     @default(0) // è´­ä¹°é‡‘é¢
  currency       String    @default("USD") // è´§å¸

  // è®¸å¯è¯å¯†é’¥ (åŠ å¯†å­˜å‚¨)
  licenseKeyHash String? // è®¸å¯è¯å¯†é’¥å“ˆå¸Œ

  // è®¸å¯è¯ç±»å‹å’Œæœ‰æ•ˆæœŸ
  licenseType    String    @default("perpetual") // 'subscription', 'perpetual', 'trial'
  expiresAt      DateTime? // è¿‡æœŸæ—¶é—´ (è®¢é˜…ç±»å‹)
  gracePeriodDays Int      @default(7) // å®½é™æœŸå¤©æ•°

  // åŠŸèƒ½é™åˆ¶
  features       String?   // JSON æ•°ç»„: å…è®¸çš„åŠŸèƒ½åˆ—è¡¨
  maxTenants     Int?      // æœ€å¤§ç§Ÿæˆ·æ•°
  maxUsers       Int?      // æœ€å¤§ç”¨æˆ·æ•°

  // å®¢æˆ·ä¿¡æ¯
  customerEmail  String?
  customerName   String?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  plugin         Plugin    @relation(fields: [pluginId], references: [slug])

  @@index([pluginId])
  @@index([status])
  @@map("plugin_licenses")
}

// æ’ä»¶å®‰è£…è¡¨ - å•å•†æˆ·æ¨¡å¼ä¸‹ç³»ç»Ÿçº§å®‰è£…
model PluginInstallation {
  id       String  @id @default(cuid())
  pluginId String  @unique // å•å•†æˆ·æ¨¡å¼ä¸‹æ¯ä¸ªæ’ä»¶åªå®‰è£…ä¸€æ¬¡
  status   String  @default("ACTIVE") // 'ACTIVE', 'INACTIVE', 'TRIAL', 'EXPIRED'
  enabled  Boolean @default(true) // æ˜¯å¦å¯ç”¨

  // ğŸ†• å®‰è£…å’Œè¯•ç”¨ä¿¡æ¯
  installedAt    DateTime  @default(now()) // å®‰è£…æ—¶é—´
  trialStartDate DateTime? // è¯•ç”¨å¼€å§‹æ—¶é—´
  trialEndDate   DateTime? // è¯•ç”¨ç»“æŸæ—¶é—´

  // ğŸ†• é…ç½®æ•°æ®
  configData String? // JSONæ ¼å¼çš„æ’ä»¶é…ç½®æ•°æ®

  // ğŸ†• å¤–éƒ¨æ’ä»¶å®‰è£…ä¿¡æ¯
  externalInstallationId String? // å¤–éƒ¨æ’ä»¶çš„å®‰è£…IDï¼ˆå¦‚OAuthæµç¨‹ä¸­è·å¾—ï¼‰
  accessToken            String? // å¤–éƒ¨æ’ä»¶çš„è®¿é—®ä»¤ç‰Œ
  refreshToken           String? // å¤–éƒ¨æ’ä»¶çš„åˆ·æ–°ä»¤ç‰Œ
  tokenExpiresAt         DateTime? // è®¿é—®ä»¤ç‰Œè¿‡æœŸæ—¶é—´

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  plugin Plugin @relation(fields: [pluginId], references: [id])

  @@index([externalInstallationId])
  @@map("plugin_installations")
}

// æ’ä»¶ä½¿ç”¨é‡è¡¨ - å•å•†æˆ·æ¨¡å¼ä¸‹ç³»ç»Ÿçº§ç»Ÿè®¡
model PluginUsage {
  id         String   @id @default(cuid())
  pluginSlug String
  metricName String // 'transactions', 'api_calls', etc.
  value      Int      @default(0)
  period     String // '2024-01' (å¹´-æœˆ)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([pluginSlug, metricName, period])
  @@map("plugin_usage")
}

// æ”¯ä»˜è®°å½•è¡¨
model Payment {
  id       String @id @default(cuid())
  orderId  String

  // ğŸ†• å…³è”åˆ°æ’ä»¶ - ç”¨äºè¿½è¸ªå“ªä¸ªæ”¯ä»˜æ’ä»¶å¤„ç†çš„æ”¯ä»˜
  pluginId String?
  plugin   Plugin? @relation(fields: [pluginId], references: [id])

  // ğŸ†• æ”¯ä»˜é‡è¯•ç›¸å…³å­—æ®µ
  attemptNumber Int       @default(1) // ç¬¬å‡ æ¬¡æ”¯ä»˜å°è¯•
  expiresAt     DateTime? // æ”¯ä»˜ä¼šè¯è¿‡æœŸæ—¶é—´ï¼ˆStripe Session 24å°æ—¶ï¼‰
  failureReason String? // å¤±è´¥åŸå› 

  paymentMethod   String // 'stripe', 'paypal', etc. - ç”¨äºæ˜¾ç¤º
  paymentIntentId String? // Stripe Payment Intent ID
  sessionId       String? // Stripe Checkout Session ID
  sessionUrl      String? // ğŸ†• Stripe Checkout Session URL - ç”¨äºSessionå¤ç”¨
  amount          Float
  currency        String   @default("USD")
  status          String   @default("PENDING") // 'PENDING', 'SUCCEEDED', 'FAILED'
  metadata        String? // JSONæ ¼å¼çš„é¢å¤–æ•°æ®
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  order  Order  @relation(fields: [orderId], references: [id])

  @@index([pluginId])
  @@index([paymentIntentId])
  @@index([sessionId])
  @@index([orderId, attemptNumber])
  @@map("payments")
}

// è®¢é˜…è®¡åˆ’æ¨¡æ¿è¡¨ï¼ˆæ’ä»¶å®šä»·ï¼‰
model SubscriptionPlan {
  id          String  @id @default(cuid())
  pluginId    String
  planId      String // 'basic_monthly', 'pro_yearly', etc.
  name        String // 'åŸºç¡€æœˆä»˜è®¡åˆ’'
  description String?

  // å®šä»·ä¿¡æ¯
  amount        Float
  currency      String  @default("USD")
  billingCycle  String // 'monthly', 'yearly', 'quarterly'
  trialDays     Int?    @default(0)
  stripePriceId String? // Stripe Price ID for checkout (e.g., 'price_xxx')

  // åŠŸèƒ½å’Œé™åˆ¶
  features String // JSONæ ¼å¼çš„åŠŸèƒ½åˆ—è¡¨
  limits   String // JSONæ ¼å¼çš„ä½¿ç”¨é‡é™åˆ¶

  // è®¡åˆ’æ§åˆ¶
  isActive  Boolean @default(true)
  isPublic  Boolean @default(true)
  sortOrder Int     @default(0)

  // å…ƒæ•°æ®
  metadata  String? // JSONæ ¼å¼
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  plugin Plugin @relation(fields: [pluginId], references: [id])

  @@unique([pluginId, planId])
  @@index([pluginId])
  @@index([isActive])
  @@map("subscription_plans")
}


// ============================================
// ç³»ç»Ÿè®¾ç½®è¡¨ - ç”¨äºå®‰è£…å¼•å¯¼å’Œå…¨å±€é…ç½®
// ============================================
model SystemSettings {
  id        String   @id @default("system")

  // å®‰è£…çŠ¶æ€
  isInstalled     Boolean  @default(false)
  installedAt     DateTime?
  installedBy     String?  // å®‰è£…äººçš„ç”¨æˆ·ID

  // ç³»ç»Ÿç‰ˆæœ¬
  version         String   @default("1.0.0")
  lastUpdatedAt   DateTime?

  // å…¨å±€é…ç½® (JSON)
  siteName        String   @default("Jiffoo Mall")
  siteDescription String?
  logoUrl         String?
  faviconUrl      String?

  // åŠŸèƒ½å¼€å…³
  maintenanceMode Boolean  @default(false)
  allowRegistration Boolean @default(true)
  requireEmailVerification Boolean @default(true)

  // å…¶ä»–è®¾ç½® (JSONæ ¼å¼å­˜å‚¨æ‰©å±•é…ç½®)
  settings        String?  // JSONæ ¼å¼çš„æ‰©å±•è®¾ç½®

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

// ============================================
// å·²å®‰è£…ä¸»é¢˜è¡¨ - æ‰©å±•ç³»ç»Ÿ
// ============================================
model InstalledTheme {
  id        String   @id @default(cuid())

  // ä¸»é¢˜æ ‡è¯†
  slug      String   @unique // ä¸»é¢˜å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆå•å•†æˆ·æ¨¡å¼ä¸‹å…¨å±€å”¯ä¸€ï¼‰
  target    String   // 'shop' | 'admin' - ä¸»é¢˜ç›®æ ‡åº”ç”¨

  // ä¸»é¢˜å…ƒæ•°æ®
  name      String   // ä¸»é¢˜åç§°
  version   String   // ä¸»é¢˜ç‰ˆæœ¬
  author    String?  // ä¸»é¢˜ä½œè€…
  description String? // ä¸»é¢˜æè¿°

  // å®‰è£…ä¿¡æ¯
  source    String   @default("local-zip") // 'local-zip' | 'official-market'
  installPath String // å®‰è£…è·¯å¾„ï¼ˆç›¸å¯¹äº extensions/themes/ï¼‰

  // çŠ¶æ€
  isActive  Boolean  @default(false) // æ˜¯å¦ä¸ºå½“å‰æ¿€æ´»çš„ä¸»é¢˜

  // ä¸»é¢˜é…ç½®ï¼ˆJSONæ ¼å¼ï¼‰
  config    String?  // ä¸»é¢˜é…ç½®è¦†ç›–

  installedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([target])
  @@index([isActive])
  @@map("installed_themes")
}

// ============================================
// CMS å†…å®¹ç®¡ç†ç³»ç»Ÿ
// ============================================

model CmsPost {
  id          String    @id @default(cuid())
  title       String
  slug        String    @unique
  content     String?   @db.Text
  excerpt     String?
  status      String    @default("DRAFT") // DRAFT, PUBLISHED, SCHEDULED, ARCHIVED
  authorId    String
  publishedAt DateTime?
  scheduledAt DateTime?
  featuredImage String?
  viewCount   Int       @default(0)

  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // å…³ç³»
  categories CmsCategory[]
  tags       CmsTag[]
  author     User          @relation(fields: [authorId], references: [id])
  revisions  CmsRevision[]

  @@index([slug])
  @@index([status])
  @@index([authorId])
  @@index([publishedAt])
  @@map("cms_posts")
}

model CmsPage {
  id       String  @id @default(cuid())
  title    String
  slug     String  @unique
  content  String? @db.Text
  template String  @default("default")
  parentId String?
  order    Int     @default(0)
  isHome   Boolean @default(false)

  // SEO
  metaTitle       String?
  metaDescription String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // è‡ªå¼•ç”¨å…³ç³»
  parent   CmsPage?  @relation("PageHierarchy", fields: [parentId], references: [id])
  children CmsPage[] @relation("PageHierarchy")

  @@index([slug])
  @@index([parentId])
  @@map("cms_pages")
}

model CmsCategory {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  parentId    String?
  order       Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  parent   CmsCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children CmsCategory[] @relation("CategoryHierarchy")
  posts    CmsPost[]

  @@index([slug])
  @@index([parentId])
  @@map("cms_categories")
}

model CmsTag {
  id    String @id @default(cuid())
  name  String
  slug  String @unique

  createdAt DateTime @default(now())

  // å…³ç³»
  posts CmsPost[]

  @@index([slug])
  @@map("cms_tags")
}

model CmsRevision {
  id        String   @id @default(cuid())
  postId    String
  title     String
  content   String?  @db.Text
  authorId  String
  createdAt DateTime @default(now())

  // å…³ç³»
  post CmsPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@map("cms_revisions")
}

model CmsMedia {
  id          String  @id @default(cuid())
  filename    String
  originalName String
  mimeType    String
  size        Int
  url         String
  alt         String?
  caption     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([mimeType])
  @@map("cms_media")
}

// ============================================
// i18n å›½é™…åŒ–ç³»ç»Ÿ
// ============================================

model I18nLanguage {
  id         String  @id @default(cuid())
  locale     String  @unique // e.g., 'en', 'zh-CN', 'ja'
  name       String  // e.g., 'English', 'Chinese', 'Japanese'
  nativeName String  // e.g., 'English', 'ä¸­æ–‡', 'æ—¥æœ¬èª'
  flag       String? // emoji or icon code
  isEnabled  Boolean @default(true)
  isDefault  Boolean @default(false)
  isRTL      Boolean @default(false)
  order      Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isEnabled])
  @@index([isDefault])
  @@map("i18n_languages")
}

model I18nTranslation {
  id         String  @id @default(cuid())
  locale     String  // language code
  entityType String  // 'product', 'category', 'cms_post', etc.
  entityId   String  // ID of the entity
  key        String  // field name, e.g., 'name', 'description'
  value      String  @db.Text
  isOutdated Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([locale, entityType, entityId, key])
  @@index([locale])
  @@index([entityType, entityId])
  @@map("i18n_translations")
}
